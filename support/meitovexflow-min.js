var MeiLib={};MeiLib.JSON={};MeiLib.RuntimeError=function(a,b){this.errorcode=a;this.message=b};MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.EventEnumerator=function(a){this.init(a)};MeiLib.EventEnumerator.prototype.init=function(a){if(!a){throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined")}this.node=a;this.next_evnt=null;this.EoI=true;this.children=$(this.node).children();this.i_next=-1;this.read_ahead()};MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")};MeiLib.EventEnumerator.prototype.read_ahead=function(){if(this.beam_enumerator){if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true;this.beam_enumerator=null;this.step_ahead()}}else{this.step_ahead()}};MeiLib.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");if(a==="note"||a==="rest"||a==="mRest"||a==="chord"){this.EoI=false}else{if(a==="beam"){this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt);if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true}}}}else{this.EoI=true}};MeiLib.AppReplacement=function(b,a){this.tagname=b;this.xmlID=a};MeiLib.createSingleVariantPathScore=function(c,f){var b=f.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","score");var d=b[0].cloneNode(true);var e=$(d).find("app");var a;var g;$(e).each(function(l,j){var o=$(j).attr("xml:id");var h=c[o];if(h){g=h.xmlID;var s=h.tagname;var p=$(d).find(s+'[xml\\:id="'+g+'"]')[0];if(!p){throw new MeiLib.RuntimeError("MeiLib.createSingleVariantPathScore():E01","Cannot find <lem> or <rdg> with @xml:id '"+g+"'.")}a=p.childNodes}else{var n=$(j).find("lem")[0];if(n){g=MeiLib.XMLID(n);a=n.childNodes}else{var m=$(j).find("rdg")[0];g=MeiLib.XMLID(m);a=m.childNodes}}var r=j.parentNode;var q=f.createProcessingInstruction("MEI2VF",'rdgStart="'+g+'"');r.insertBefore(q,j);$.each(a,function(){r.insertBefore(this.cloneNode(true),j)});var k=f.createProcessingInstruction("MEI2VF",'rdgEnd="'+g+'"');r.insertBefore(k,j);r.removeChild(j)});return d};MeiLib.parseSourceList=function(c){var f=$(c).find("sourceDesc").children();var a={};var b;for(b=0;b<f.length;++b){var g=f[b];var e=$(g).attr("xml:id");var d=new XMLSerializer();a[e]=d.serializeToString(g)}return a};MeiLib.JSON.parseSourceList=function(a){return JSON.stringify(MeiLib.parseSourceList(a))};MeiLib.App=function(a){this.xmlID=a;this.variants=[]};MeiLib.Variant=function(c,a,b){this.tagname=c;this.xmlID=a;this.source=b};MeiLib.parseAPPs=function(d){var c=d.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","score");var a=[];var b=$(c).find("app");a=$.map(b,function(j,f){var h=MeiLib.XMLID(j);var e=$(j).find("rdg, lem");var g=new MeiLib.App(h);g.variants=$.map(e,function(i){var m=$(i).prop("localName");var k=MeiLib.XMLID(i);var l=$(i).attr("source");return new MeiLib.Variant(m,k,l)});return g});return a};MeiLib.JSON.parseAPPs=function(a){return JSON.stringify(MeiLib.parseAPPs(a))};MeiLib.durationOf=function(f,c){IsSimpleEvent=function(g){return(g==="note"||g==="rest"||g==="space")};var e=function(h,i){var g=$(h).attr("dur");if(!g){throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note>, <rest> or <space> must be specified.")}return MeiLib.dotsMult(h)*MeiLib.dur2beats(Number(g),i)};var d=function(j,h,i){if(!i){i="1"}var g=$(j).attr("dur");var k=MeiLib.dotsMult(j);if(g){return k*MeiLib.dur2beats(Number(g),h)}$(j).find("note").each(function(){lyr_n=$(this).attr("layer");if(!lyr_n||lyr_n===i){var m=$(this).attr("dur");var l=MeiLib.dotsMult(j);if(!g&&m){g=m;k=l}else{if(g&&g!=m){throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}}});if(g){return k*MeiLib.dur2beats(Number(g),h)}throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")};var a=function(g,i){var h=0;g.children().each(function(){var l;var k;var j=this.prop("localName");if(IsSimpleEvent(j)){l=e(this,i)}else{if(j==="chord"){l=d(this,i)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+j+"'")}}h+=l});return h};var b=$(f).prop("localName");if(IsSimpleEvent(b)){return e(f,c)}else{if(b==="mRest"){return c.count}else{if(b==="chord"){return d(f,c)}else{if(b==="beam"){return a(f,c)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+b+"'")}}}}};MeiLib.tstamp2id=function(i,h,c){var j=Number(i);var b=0;var f=function(){return b+1};var g=function(){return j-f()};var a=new MeiLib.EventEnumerator(h);var n;var l;var k;var d;while(!a.EoI&&(l===undefined||l>0)){k=n;d=l;n=a.nextEvent();l=g();b+=MeiLib.durationOf(n,c)}if(l===undefined){return undefined}var e;if(l<0){if(k&&d<Math.abs(l)){e=k}else{e=n}}else{e=n}var m;m=$(e).attr("xml:id");if(!m){m=MeiLib.createPseudoUUID();$(e).attr("xml:id",m)}return m};MeiLib.XMLID=function(a){xml_id=$(a).attr("xml:id");if(!xml_id){xml_id=MeiLib.createPseudoUUID();$(a).attr("xml:id",xml_id)}return xml_id};MeiLib.id2tstamp=function(b,d){var f;var e=false;for(var c=0;c<d.length&&!e;++c){if(d[c].meter){f=d[c].meter}if(c===0&&!f){throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified")}var a=MeiLib.sumUpUntil(b,d[c].layer,f);if(a.found){e=true;return c.toString()+"m"+"+"+(a.beats+1).toString()}}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+b+'" was found in the given MEI context.')};MeiLib.dur2beats=function(a,b){return(b.unit/a)};MeiLib.beats2dur=function(a,b){return(b.unit/a)};MeiLib.dotsMult=function(a){var c=$(a).attr("dots");c=Number(c||"0");var b=1;for(;c>0;--c){b+=(1/Math.pow(2,c))}return b};MeiLib.sumUpUntil=function(b,c,d){var a=function(o){var g=$(o);var l=g.prop("localName");if(l==="note"||l==="rest"){if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var e=Number(g.attr("dur"));if(!e){throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).")}var j=g.attr("dots");j=Number(j||"0");var m=MeiLib.dotsMult(g)*MeiLib.dur2beats(e,d);return{beats:m,found:false}}}else{if(l==="mRest"){if(g.attr("xml:id")===b){p=true;return{beats:0,found:true}}else{return{beats:d.count,found:false}}}else{if(l==="layer"||l==="beam"){var m=0;var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m+=k.beats;p=k.found}return{beats:m,found:p}}else{if(l==="chord"){var n=g.attr("dur");if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var n=g.attr("dur");if(n){if(g.find("[xml\\:id='"+b+"']").length){return{beats:0,found:true}}else{return{beats:MeiLib.dur2beats(n,d),found:p}}}else{var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m=k.beats;p=k.found}return{beats:m,found:p}}}}}}}return{beats:0,found:false}};return a(c)};mei2vexflowTables={};mei2vexflowTables.positions={"above":Vex.Flow.Modifier.Position.ABOVE,"below":Vex.Flow.Modifier.Position.BELOW};mei2vexflowTables.hairpins={"cres":Vex.Flow.StaveHairpin.type.CRESC,"dim":Vex.Flow.StaveHairpin.type.DECRESC};mei2vexflowTables.articulations={"acc":"a>","stacc":"a.","ten":"a-","stacciss":"av","marc":"a^","dnbow":"am","upbow":"a|","snap":"ao","lhpizz":"a+","dot":"a.","stroke":"a|"};Node.prototype.attrs=function(){var b;var a={};for(b in this.attributes){a[this.attributes[b].name]=this.attributes[b].value}return a};Array.prototype.all=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===false){return false}}return true};Array.prototype.any=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===true){return true}}return false};MEI2VF={};MEI2VF.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};MEI2VF.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};MEI2VF.render_notation=function(F,T,aq,p){var aq=aq||800;var p=p||350;var L;var a;var au=13;var ac;var ap=[];var q=[];var at=[];var P=[];var k={};var f=[];var ah=[];var D=[];var B=[];var ag=[];var ae=50;var aB=20;var aA=0;var al=aB;var z=0;var G=0;var ax=0;var b=false;var ad=true;var M=new Array();var aD=0;var h={};var E=new MEI2VF.StaveVoices();var O=function(aF){Vex.Log("count_measures_siblings_till_sb() {}");if(aF.length===0){return 0}switch($(aF).prop("localName")){case"measure":return 1+O($(aF).next());case"sb":return 0;default:return O($(aF).next())}};var X=function(aF){L=O(aF);a=Math.round((aq-aB)/L);Vex.LogDebug("update_measure_width(): "+L+", width:"+a)};var r=function(aF){X(aF);Vex.LogDebug("startSystem() {enter}");if(ad){ax=0;al=aB;G+=1;aA=z+ae*(aA>0?1:0);ad=false;b=false;$.each(M,function(aG,aH){if(aH){aH.renderWith.clef=true;aH.renderWith.keysig=true;aH.renderWith.timesig=true}})}else{if(b){ax=0;al=aB;G+=1;aA=z+ae;b=false;$.each(M,function(aG,aH){if(aH){aH.renderWith.clef=true;aH.renderWith.keysig=true}})}}};var n=function(){if(ap[ap.length-1]){var aF=ap[ap.length-1][0];al=aF.x+aF.width;Vex.LogDebug("moveOneMeasure(): measure_left:"+al)}else{al=aB}};var N=function(){return(ad||b)};var I=function(aG,aH){var aF=ai(aG,aH);if(!aF){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+aH+" is mandatory.")}return aF};var ai=function(aG,aH){var aF=$(aG).attr(aH);return aF};var H=function(aG){aG=(typeof aG==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aG;var aH=$(aG).attr("pname");var aF=$(aG).attr("oct");if(!aH||!aF){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>")}return aH+"/"+aF};var av=function(aF){var aH=$(aF).find("syl");var aG="";$(aH).each(function(aJ,aK){var aL=($(aK).attr("wordpos")=="i"||$(aK).attr("wordpos")=="m")?"-":"";aG+=(aJ>0?"\n":"")+$(aK).text()+aL});var aI=(aH.attr("wordpos")=="i"||aH.attr("wordpos")=="m")?"-":"";return aG};var s=function(aJ,aG){var aH=$(aJ).find("dir");var aF="";var aI="";$(aH).each(function(){var aM=I(this,"startid");var aL=I(aG,"xml:id");var aK=I(this,"place");if(aM===aL){aF+=$(this).text().trim();aI=aK}});return[aF,aI]};var S=function(aG,aF){aG={pitch:aG.split("/")[0][0],octave:Number(aG.split("/")[1])};aF={pitch:aF.split("/")[0][0],octave:Number(aF.split("/")[1])};if(aG.octave===aF.octave){if(aG.pitch===aF.pitch){return 0}else{if(aG.pitch<aF.pitch){return -1}else{if(aG.pitch>aF.pitch){return 1}}}}else{if(aG.octave<aF.octave){return -1}else{if(aG.octave>aF.octave){return 1}}}};var ay=function(aF){aF=String(aF);if(aF==="1"){return"w"}if(aF==="2"){return"h"}if(aF==="4"){return"q"}if(aF==="8"){return"8"}if(aF==="16"){return"16"}if(aF==="32"){return"32"}if(aF==="64"){return"64"}throw new Vex.RuntimeError("BadArguments",'The MEI duration "'+aF+'" is not supported.')};var i=function(aF,aI){aI=aI||true;aF=(typeof aF==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aF;var aG=$(aF).attr("dur");if(aG===undefined){alert("Could not get duration from:\n"+JSON.stringify(aF,null,"\t"))}var aH=ay(aG);if(aI===true&&$(aF).attr("dots")==="1"){aH+="d"}return aH};var U=function(aF){if(aF==="n"){return"n"}if(aF==="f"){return"b"}if(aF==="s"){return"#"}if(aF==="ff"){return"bb"}if(aF==="ss"){return"##"}throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+aF)};var W=function(aG,aF){var aH=$(aG).attr("stem.dir");if(aH!==undefined){return(aH==="up")?Vex.Flow.StaveNote.STEM_UP:(aH==="down")?Vex.Flow.StaveNote.STEM_DOWN:undefined}else{var aI=J($(aF).attr("n"));if(aI==="treble"){return(S("a/5",H(aG))===1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}else{if(aI==="bass"){return(S("c/3",H(aG))===-1)?Vex.Flow.StaveNote.STEM_DOWN:Vex.Flow.StaveNote.STEM_UP}}}};var ao=function(aF){if($(aF).attr("key.pname")!==undefined){var aI=$(aF).attr("key.pname").toUpperCase();var aH=$(aF).attr("key.accid");if(aH!==undefined){switch(aH){case"s":aI+="#";break;case"f":aI+="b";break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}}var aG=$(aF).attr("key.mode");if(aG!==undefined){aI+=aG==="major"?"":"m"}return aI}else{return"C"}};var g=function(aF){var aG=I(aF,"clef.shape");var aH=ai(aF,"clef.line");if(aG==="G"&&(!aH||aH==="2")){return"treble"}else{if(aG==="F"&&(!aH||aH==="4")){return"bass"}else{if(aG==="C"&&aH==="3"){return"alto"}else{if(aG==="C"&&aH==="4"){return"tenor"}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+aG+'" '+(aH?('clef.line="'+aH+'"'):"")+" ]")}}}}};var J=function(aF){if(aF>=M.length){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.staff_clef():E01","No staff definition for staff n="+aF)}var aG=M[aF].staffDef;return g(aG)};var aE=function(aF){if($(aF).attr("meter.count")!==undefined&&$(aF).attr("meter.unit")!==undefined){return $(aF).attr("meter.count")+"/"+$(aF).attr("meter.unit")}};var ak=function(aF){var aG=new Vex.Flow.Renderer(aF,Vex.Flow.Renderer.Backends.CANVAS);ac=aG.getContext()};var x=function(aF){return 100};var l=function(aH){var aF=0;var aG;for(aG=0;aG<aH-1;aG++){aF+=x(aG)}return aF};var j=function(aH){var aF=aA+l(aH);var aG=aF+x(aH);if(aG>z){z=aG}return aF};var af=function(aH,aG){if(!aH){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".')}var aI=M[aH].staffDef;var aF=new Vex.Flow.Stave(al,j(aH),aG);if(M[aH].renderWith.clef){aF.addClef(g(aI));M[aH].renderWith.clef=false}if(M[aH].renderWith.keysig){if($(aI).attr("key.sig.show")==="true"||$(aI).attr("key.sig.show")===undefined){aF.addKeySignature(ao(aI))}M[aH].renderWith.keysig=false}if(M[aH].renderWith.timesig){if($(aI).attr("meter.rend")==="norm"||$(aI).attr("meter.rend")===undefined){aF.addTimeSignature(aE(aI))}M[aH].renderWith.timesig=false}aF.setContext(ac).draw();aD=aF.barXShift;Vex.LogDebug("initialise_staff_n(): staffXShift="+aD);return aF};var aj=function(){var aF=$(F).find("scoreDef")[0];if(!aF){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found.")}u(aF);$(F).find("section").children().each(R);$.each(at,function(aH,aG){aG.setContext(ac).draw()});Q(ah);Q(D);aC(B)};var Q=function(aF){$(aF).each(function(aJ,aK){var aH=k[aK.getFirstId()];var aL=k[aK.getLastId()];var aI;if(aH){aI=aH.vexNote}var aG;if(aL){aG=aL.vexNote}new Vex.Flow.StaveTie({first_note:aI,last_note:aG}).setContext(ac).draw()})};var aC=function(aF){$(aF).each(function(aI,aN){var aO=k[aN.getFirstId()];var aK=k[aN.getLastId()];var aM;if(aO){aM=aO.vexNote}var aG;if(aK){aG=aK.vexNote}var aH=mei2vexflowTables.positions[aN.params.place];var aL=mei2vexflowTables.hairpins[aN.params.form];var aJ=0;var aQ=0;var aP={height:10,y_shift:0,left_shift_px:aJ,r_shift_px:aQ};new Vex.Flow.StaveHairpin({first_note:aM,last_note:aG,},aL).setContext(ac).setRenderOptions(aP).setPosition(aH).draw()})};var aw=function(){for(var aI in h){var aJ=h[aI];var aF=aJ.vexType();var aG=f[aJ.top_staff_n];var aH=f[aJ.bottom_staff_n];if(aF&&aG&&aH){var aK=new Vex.Flow.StaveConnector(aG,aH);aK.setType(aJ.vexType());aK.setContext(ac);aK.draw()}}};var R=function(aF,aH){switch($(aH).prop("localName")){case"measure":var aG;if(N()){r(aH);aG=true}else{n();aG=false}E.reset();v(aH);if(aG){aw();aG=false}E.format(a-aD-20);E.draw(ac,f);az(aH,"tie",ah);az(aH,"slur",D);az(aH,"hairpin",B);break;case"scoreDef":u(aH);break;case"staffDef":y(aH);break;case"sb":ab(aH);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aH).prop("localName")+"> is not supported in <section>")}};var ab=function(aF){b=true};var u=function(aF){$(aF).children().each(Z)};var Z=function(aF,aG){switch($(aG).prop("localName")){case"staffGrp":c(aG);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aG).prop("localName")+"> is not supported in <scoreDef>")}};var c=function(aH){var aF={};var aG=aH.attrs().symbol;$(aH).children().each(function(aJ,aK){var aI=am(aJ,aK);Vex.LogDebug("process_staffGrp() {1}.{a}: local_result.first_n:"+aI.first_n+" local_result.last_n:"+aI.last_n);if(aJ===0){aF.first_n=aI.first_n;aF.last_n=aI.last_n}else{aF.last_n=aI.last_n}});Vex.LogDebug("process_staffGrp() {2}: symbol:"+aG+" result.first_n:"+aF.first_n+" result.last_n:"+aF.last_n);h[aF.first_n.toString()+":"+aF.last_n.toString()]=new MEI2VF.StaveConnector(aG,aF.first_n,aF.last_n);return aF};var am=function(aF,aH){switch($(aH).prop("localName")){case"staffDef":var aG=y(aH);return{first_n:aG,last_n:aG};break;case"staffGrp":return c(aH);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aH).prop("localName")+"> is not supported in <staffGrp>")}};var y=function(aF){var aG=Number(aF.attrs().n);var aH=M[aG];if(aH){M[aG].updateDef(aF)}else{M[aG]=new MEI2VF.StaffInfo(aF,true,true,true)}return aG};var v=function(aF){ap.push($(aF).find("staff").map(function(aH,aG){return an(aH,aG,aF)}).get())};var an=function(aI,aL,aK){var aO,aG,aN;var aH=Number(aL.attrs().n);var aF=Number(aK.attrs().n);aO=af(aH,a);var aM=$(aL).find("layer").map(function(aQ,aP){return Y(aQ,aP,aL,aK)}).get();var aJ=[];$(aM).each(function(){var aP=$(this.events).get().map(function(aQ){return aQ.vexNote?aQ.vexNote:aQ});E.addVoice(V(null,aP),aH)});f[aH]=aO;if(q[aF]===undefined){q[aF]=[]}q[aF][aH]=aO;return aO};var Y=function(aI,aJ,aL,aK){var aF=aK.attrs().n;if(!aF){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_events:","<measure> must have @n specified")}var aH=aL.attrs().n;if(!aH){aH="1"}var aG=aJ.attrs().n;if(!aG){aG="1"}var aM=M[aH].staffDef;var aN=aF+":"+aH+":"+aG;if(ag[aN]){$(ag[aN]).each(function(aO,aP){var aR=$(aM).attr("meter.count");var aQ=$(aM).attr("meter.unit");var aS={count:Number(aR),unit:Number(aQ)};aP.setContext({layer:aJ,meter:aS});ag[aN][aO]=null});ag[aN]=null}return{layer:aI,events:$(aJ).children().map(function(aP,aO){return K(aO,aJ,aL,aK)}).get()}};var az=function(aL,aM,aH){var aF=function(aP){var aO=aP.attrs().staff;if(!aO){aO="1"}var aN=aP.attrs().layer;if(!aN){aN="1"}return{staff_n:aO,layer_n:aN}};var aG=function(aR,aP,aN){var aT=aF(aP);var aV=$(aN).find('staff[n="'+aT.staff_n+'"]');var aQ=$(aV).find('layer[n="'+aT.layer_n+'"]').get(0);if(!aQ){var aU=$(aV).find("layer");if(aU&&!aU.attr("n")){aQ=aU}if(!aQ){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}}var aS=M[aT.staff_n].staffDef;if(!aS){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.")}var aO={count:Number(aS.attrs()["meter.count"]),unit:Number(aS.attrs()["meter.unit"])};if(!aO.count||!aO.unit){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.")}return MeiLib.tstamp2id(aR,aQ,aO)};var aK=function(aO){var aN;return aO.substring(0,aO.indexOf("m"))};var aI=function(aO){var aN;return aO.substring(aO.indexOf("+")+1)};var aJ=$(aL).find(aM);$.each(aJ,function(aX,aV){var aQ=new MEI2VF.EventLink(null,null);if(aM==="hairpin"){var aP=aV.attrs().form;if(!aP){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.")}var aT=aV.attrs().place;aQ.setParams({form:aP,place:aT})}var aS=aV.attrs().startid;if(aS){aQ.setFirstId(aS)}else{var aY=aV.attrs().tstamp;if(aY){aS=aG(aY,aV,aL);aQ.setFirstId(aS)}else{}}var aW=aV.attrs().endid;if(aW){aQ.setLastId(aW)}else{var aU=aV.attrs().tstamp2;if(aU){var aR=Number(aK(aU));if(aR>0){aQ.setLastTStamp(aI(aU));var aO=aF(aV);var aN=aL.attrs().n;var aZ=Number(aN)+aR;var a0=aZ.toString()+":"+aO.staff_n+":"+aO.layer_n;if(!ag[a0]){ag[a0]=new Array()}ag[a0].push(aQ)}else{aW=aG(aI(aU),aV,aL);aQ.setLastId(aW)}}else{}}aH.push(aQ)})};var t=function(aI,aH,aF){var aG=new MEI2VF.EventLink(aI,aH);aF.push(aG)};var w=function(aI,aF,aG){var aH=new MEI2VF.EventLink(aI,null);aH.setParams({linkCond:aF});aG.push(aH)};var A=function(aK,aF){var aG=function(aM,aL){return(aM&&aL&&aM.pname===aL.pname&&aM.oct===aL.oct&&aM.system===aL.system)};if(!aF.pname||!aF.oct){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or specified for the tie")}var aJ=false;var aH;var aI;for(aH=0;!aJ&&aH<ah.length;++aH){aI=ah[aH];if(!aI.getLastId()){if(aG(aI.params.linkCond,aF)){aJ=true;aI.setLastId(aK)}else{}}}if(!aJ){var aI=new MEI2VF.EventLink(null,aK);ah.push(aI)}};var e=function(aL,aF){var aH=function(aN,aM){return aN.nesting_level===aM.nesting_level&&aN.system===aM.system};var aK=false;var aJ=0;var aG;for(aJ=0;!aK&&aJ<D.length;++aJ){var aI=D[aJ];if(aI&&!aI.getLastId()&&aH(aI.params.linkCond,aF)){aK=true;aI.setLastId(aL)}}if(!aK){var aI=new MEI2VF.EventLink(null,aL);D.push(aI)}};var d=function(aG){var aF=[];var aH=aG.split(" ");$.each(aH,function(aJ,aK){var aI;if(aK.length===1){aF.push({letter:aK,nesting_level:0})}else{if(aK.length===2){if(!(aI=Number(aK[1]))){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}aF.push({letter:aK[0],nesting_level:aI})}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}}});return aF};var m=function(aG,aL,aW,aN){var aU=function(aX){return(new Vex.Flow.Annotation(aX)).setFont("Times",au).setBottom(true)};var aF=function(aX){return(new Vex.Flow.Annotation(aX)).setFont("Times",au)};try{var aI=new Vex.Flow.StaveNote({keys:[H(aG)],clef:J($(aW).attr("n")),duration:i(aG),stem_direction:W(aG,aW)});aI.addAnnotation(2,aU(av(aG)));var aO=s(aN,aG);aI.addAnnotation(2,aO[1]=="below"?aU(aO[0]):aF(aO[0]));try{var aV;for(aV=0;aV<parseInt($(aG).attr("dots"));aV++){aI.addDotToAll()}}catch(aP){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the dots of <note>: "+JSON.stringify(aG.attrs())+'. "'+aP.toString()+'"')}var aK=$(aG).attr("accid");if(aK){aI.addAccidental(0,new Vex.Flow.Accidental(U(aK)))}$.each($(aG).find("artic"),function(aY,aX){aI.addArticulation(0,new Vex.Flow.Articulation(mei2vexflowTables.articulations[$(aX).attr("artic")]).setPosition(mei2vexflowTables.positions[$(aX).attr("place")]))});$.each($(aG).children(),function(aX,aY){$(aY).remove()});var aM=$(aG).attr("xml:id");if(!aM){aM=MeiLib.createPseudoUUID();$(aG).attr("xml:id",aM)}var aQ=$(aG).attr("tie");if(!aQ){aQ=""}var aH=$(aG).attr("pname");if(!aH){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute")}var aT=$(aG).attr("oct");if(!aT){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute")}for(var aV=0;aV<aQ.length;++aV){switch(aQ[aV]){case"i":w(aM,{pname:aH,oct:aT,system:G},ah);break;case"t":A(aM,{pname:aH,oct:aT,system:G});break}}var aJ=$(aG).attr("slur");if(aJ){var aR=d(aJ);$.each(aR,function(aY,aX){switch(aX.letter){case"i":w(aM,{nesting_level:aX.nesting_level,system:G},D);break;case"t":e(aM,{nesting_level:aX.nesting_level,system:G});break}})}var aS={vexNote:aI,id:aM};P.push(aS);k[aM]={meiNote:aG,vexNote:aI};return aS}catch(aP){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <note>: "+JSON.stringify(aG.attrs())+'. "'+aP.toString()+'"')}};var aa=function(aI,aH,aG,aK){try{var aJ=new Vex.Flow.StaveNote({keys:["c/5"],duration:i(aI,false)+"r"});if($(aI).attr("dots")==="1"){aJ.addDotToAll()}return aJ}catch(aF){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <rest>: "+JSON.stringify(aI.attrs())+'. "'+aF.toString()+'"')}};var ar=function(aI,aH,aG,aK){try{var aJ=new Vex.Flow.StaveNote({keys:["c/5"],duration:"wr"});return aJ}catch(aF){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <mRest>: "+JSON.stringify(aI.attrs())+'. "'+aF.toString()+'"')}};var o=function(aH,aG,aF,aJ){var aI=$(aH).children().map(function(aK,aL){var aM=K(aL,aG,aF,aJ);return aM.vexNote?aM.vexNote:aM}).get();at.push(new Vex.Flow.Beam(aI));return aI};var C=function(aI,aF,aL,aK){try{var aN=$(aI).children().map(H).get();var aG=ay(Math.max.apply(Math,$(aI).children().map(function(){return Number($(this).attr("dur"))}).get()));var aJ=$(aI).children().map(function(){return $(this).attr("dots")==="1"}).get().any();if(aJ===true){aG+="d"}var aH=new Vex.Flow.StaveNote({keys:aN,clef:J($(aL).attr("n")),duration:aG});if(aJ===true){aH.addDotToAll()}$(aI).children().each(function(aP,aQ){var aO=$(aQ).attr("accid");if(aO!==undefined){aH.addAccidental(aP,new Vex.Flow.Accidental(U(aO)))}});return aH}catch(aM){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <chord>:"+aM.toString())}};var K=function(aH,aG,aF,aJ){var aI=$(aH).prop("localName");if(aI==="rest"){return aa(aH,aG,aF,aJ)}else{if(aI==="mRest"){return ar(aH,aG,aF,aJ)}else{if(aI==="note"){return m(aH,aG,aF,aJ)}else{if(aI==="beam"){return o(aH,aG,aF,aJ)}else{if(aI==="chord"){return C(aH,aG,aF,aJ)}else{throw new Vex.RuntimeError("BadArguments",'Rendering of element "'+aI+'" is not supported.')}}}}}};var V=function(aG,aF){if(!$.isArray(aF)){throw new Vex.RuntimeError("BadArguments","make_voice() voice_contents argument must be an array.")}var aH=new Vex.Flow.Voice({num_beats:Number($(F).find("staffDef").attr("meter.count")),beat_value:Number($(F).find("staffDef").attr("meter.unit")),resolution:Vex.Flow.RESOLUTION});aH.setStrict(false);aH.addTickables(aF);return aH};ak(T);aj();MEI2VF.rendered_measures=q};MEI2VF.EventLink=function(b,a){this.init(b,a)};MEI2VF.EventLink.prototype.init=function(b,a){this.first_ref=new MEI2VF.EventReference(b);this.last_ref=new MEI2VF.EventReference(a);this.params={}};MEI2VF.EventLink.prototype.setParams=function(a){this.params=a};MEI2VF.EventLink.prototype.setFirstRef=function(a){this.first_ref=a};MEI2VF.EventLink.prototype.setLastRef=function(a){this.last_ref=a};MEI2VF.EventLink.prototype.setFirstId=function(a){this.first_ref.setId(a)};MEI2VF.EventLink.prototype.setLastId=function(a){this.last_ref.setId(a)};MEI2VF.EventLink.prototype.setFirstTStamp=function(a){this.first_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setLastTStamp=function(a){this.last_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setContext=function(a){this.meicontext=a};MEI2VF.EventLink.prototype.getFirstId=function(){return this.first_ref.getId({meicontext:this.meicontext})};MEI2VF.EventLink.prototype.getLastId=function(){return this.last_ref.getId({meicontext:this.meicontext})};MEI2VF.EventReference=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setId=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setTStamp=function(a){this.tstamp=a;if(this.xmlid){this.tryResolveReference(true)}};MEI2VF.EventReference.prototype.tryResolveReference=function(b){var a=this.tstamp;var c=this.meicontext;if(!a){throw new MEI2VF.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.")}if(this.meicontext){this.xmlid=MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter)}else{this.xmlid=null}};MEI2VF.EventReference.prototype.getId=function(a){if(a&&a.meicontext){this.setContext(a.meicontext)}if(this.xmlid){return this.xmlid}if(this.tstamp){if(this.meicontext){this.tryResolveReference(a&&a.strict);return this.xmlid}}return null};MEI2VF.EventReference.prototype.setContext=function(a){this.meicontext=a};MEI2VF.StaffInfo=function(b,d,c,a){this.renderWith={clef:d,keysig:c,timesig:a};this.staffDef=b};MEI2VF.StaffInfo.prototype.look4changes=function(c,d){var a={clef:false,keysig:false,timesig:false};if(!c&&d){a.clef=true;a.keysig=true;a.keysig=true;return a}else{if(c&&!d){a.clef=false;a.keysig=false;a.keysig=false;return a}else{if(!c&&!d){throw new MEI2VF_RUNTIME_ERROR("BadArgument","Cannot compare two undefined staff definitions.")}}}var b=function(g,e,f){return $(g).attr(f)===$(e).attr(f)};if(!b(c,d,"clef.shape")||!b(c,d,"clef.line")){a.clef=true}if((!b(c,d,"key.pname")||!b(c,d,"key.accid")||!b(c,d))){a.keysig=true}if(!b(c,d,"meter.count")||!b(c,d,"meter.unit")){a.timesig=true}return a};MEI2VF.StaffInfo.prototype.updateDef=function(a){this.renderWith=this.look4changes(this.staffDef,a);this.staffDef=a};MEI2VF.StaveConnector=function(b,a,c){this.init(b,a,c)};MEI2VF.StaveConnector.prototype.init=function(b,a,c){this.symbol=b;this.top_staff_n=a;this.bottom_staff_n=c};MEI2VF.StaveConnector.prototype.vexType=function(){switch(this.symbol){case"line":return Vex.Flow.StaveConnector.type.SINGLE;case"brace":return Vex.Flow.StaveConnector.type.BRACE;case"bracket":return Vex.Flow.StaveConnector.type.BRACKET;case"none":return null;default:return Vex.Flow.StaveConnector.type.SINGLE}};MEI2VF.StaffVoice=function(b,a){this.voice=b;this.staff_n=a};MEI2VF.StaveVoices=function(){this.all_voices=new Array()};MEI2VF.StaveVoices.prototype.addStaffVoice=function(a){this.all_voices.push(a)};MEI2VF.StaveVoices.prototype.addVoice=function(b,a){this.addStaffVoice(new MEI2VF.StaffVoice(b,a))};MEI2VF.StaveVoices.prototype.reset=function(){this.all_voices=[]};MEI2VF.StaveVoices.prototype.format=function(b){var a=$.map(this.all_voices,function(d,c){return d.voice});new Vex.Flow.Formatter().format(a,b)};MEI2VF.StaveVoices.prototype.draw=function(d,e){var c=this.all_voices;var b;for(var a=0;a<c.length;++a){b=c[a];b.voice.draw(d,e[b.staff_n])}};