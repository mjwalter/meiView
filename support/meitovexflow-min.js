/***
* MEItoVexFlow
* 
* Author: Richard Lewis
* Contributors: Zoltan Komives, Raffaele Viglianti
* 
* See README for details of this library
* 
* Copyright Â© 2012, 2013 Richard Lewis, Raffaele Viglianti, Zoltan Komives,
* University of Maryland
* 
* Licensed under the Apache License, Version 2.0 (the "License"); you
* may not use this file except in compliance with the License.  You may
* obtain a copy of the License at
* 
*    http://www.apache.org/licenses/LICENSE-2.0
* 
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
* implied.  See the License for the specific language governing
* permissions and limitations under the License.
***/
var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a;this.message=b};MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.EventEnumerator=function(a){this.init(a)};MeiLib.EventEnumerator.prototype.init=function(a){if(!a){throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined")}this.node=a;this.next_evnt=null;this.EoI=true;this.children=$(this.node).children();this.i_next=-1;this.read_ahead()};MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")};MeiLib.EventEnumerator.prototype.read_ahead=function(){if(this.beam_enumerator){if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true;this.beam_enumerator=null;this.step_ahead()}}else{this.step_ahead()}};MeiLib.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");if(a==="note"||a==="rest"||a==="mRest"||a==="chord"){this.EoI=false}else{if(a==="beam"){this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt);if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true}}}}else{this.EoI=true}};MeiLib.durationOf=function(f,c){IsSimpleEvent=function(g){return(g==="note"||g==="rest"||g==="space")};var e=function(h,i){var g=$(h).attr("dur");if(!g){throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note>, <rest> or <space> must be specified.")}return MeiLib.dotsMult(h)*MeiLib.dur2beats(Number(g),i)};var d=function(j,h,i){if(!i){i="1"}var g=$(j).attr("dur");var k=MeiLib.dotsMult(j);if(g){return k*MeiLib.dur2beats(Number(g),h)}$(j).find("note").each(function(){lyr_n=$(this).attr("layer");if(!lyr_n||lyr_n===i){var m=$(this).attr("dur");var l=MeiLib.dotsMult(j);if(!g&&m){g=m;k=l}else{if(g&&g!=m){throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}}});if(g){return k*MeiLib.dur2beats(Number(g),h)}throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")};var a=function(g,i){var h=0;g.children().each(function(){var l;var k;var j=this.prop("localName");if(IsSimpleEvent(j)){l=e(this,i)}else{if(j==="chord"){l=d(this,i)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+j+"'")}}h+=l});return h};var b=$(f).prop("localName");if(IsSimpleEvent(b)){return e(f,c)}else{if(b==="mRest"){return c.count}else{if(b==="chord"){return d(f,c)}else{if(b==="beam"){return a(f,c)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+b+"'")}}}}};MeiLib.tstamp2id=function(i,h,c){var j=Number(i);var b=0;var f=function(){return b+1};var g=function(){return j-f()};var a=new MeiLib.EventEnumerator(h);var n;var l;var k;var d;while(!a.EoI&&(l===undefined||l>0)){k=n;d=l;n=a.nextEvent();l=g();b+=MeiLib.durationOf(n,c)}if(l===undefined){return undefined}var e;if(l<0){if(k&&d<Math.abs(l)){e=k}else{e=n}}else{e=n}var m;m=$(e).attr("xml:id");if(!m){m=MeiLib.createPseudoUUID();$(e).attr("xml:id",m)}return m};MeiLib.XMLID=function(a){xml_id=$(a).attr("xml:id");if(!xml_id){xml_id=MeiLib.createPseudoUUID();$(a).attr("xml:id",xml_id)}return xml_id};MeiLib.id2tstamp=function(b,d){var f;var e=false;for(var c=0;c<d.length&&!e;++c){if(d[c].meter){f=d[c].meter}if(c===0&&!f){throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified")}var a=MeiLib.sumUpUntil(b,d[c].layer,f);if(a.found){e=true;return c.toString()+"m"+"+"+(a.beats+1).toString()}}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+b+'" was found in the given MEI context.')};MeiLib.dur2beats=function(a,b){return(b.unit/a)};MeiLib.beats2dur=function(a,b){return(b.unit/a)};MeiLib.dotsMult=function(a){var c=$(a).attr("dots");c=Number(c||"0");var b=1;for(;c>0;--c){b+=(1/Math.pow(2,c))}return b};MeiLib.sumUpUntil=function(b,c,d){var a=function(o){var g=$(o);var l=g.prop("localName");if(l==="note"||l==="rest"){if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var e=Number(g.attr("dur"));if(!e){throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).")}var j=g.attr("dots");j=Number(j||"0");var m=MeiLib.dotsMult(g)*MeiLib.dur2beats(e,d);return{beats:m,found:false}}}else{if(l==="mRest"){if(g.attr("xml:id")===b){p=true;return{beats:0,found:true}}else{return{beats:d.count,found:false}}}else{if(l==="layer"||l==="beam"){var m=0;var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m+=k.beats;p=k.found}return{beats:m,found:p}}else{if(l==="chord"){var n=g.attr("dur");if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var n=g.attr("dur");if(n){if(g.find("[xml\\:id='"+b+"']").length){return{beats:0,found:true}}else{return{beats:MeiLib.dur2beats(n,d),found:p}}}else{var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m=k.beats;p=k.found}return{beats:m,found:p}}}}}}}return{beats:0,found:false}};return a(c)};MeiLib.SliceMEI=function(f,d){var p=function(i,q){$.each(i,function(r,s){if(q.noClef){$(s).attr("clef.visible","false")}if(q.noKey){$(s).attr("key.sig.show","false")}if(q.noMeter){$(s).attr("meter.rend","false")}})};var m=d.staves;if(m){var j="";var c="";var b="";for(var e=0;e<m.length;e++){j+=b+'[n="'+m[e]+'"]';c+=b+'[staff="'+m[e]+'"]';if(e===0){b=", "}}}var l=f.cloneNode(true);var o;if(m){$(l).find("staffDef").remove(":not("+j+")")}if(d.noClef||d.noKey||d.noMeter){var h=$(l).find("staffDef");var o=$(l).find("scoreDef");p(o,d);p(h,d)}if(d.noConnectors){$(l).find("staffGrp").removeAttr("symbol")}var k=$(l).find("section")[0];var g=false;var n=false;var a=k.childNodes;$(a).each(function(){var q=this;if(!g){if(q.localName==="measure"&&Number($(q).attr("n"))===d.start_n){g=true;n=true}else{k.removeChild(q)}}if(g){if(m){$(q).find("[staff]").remove(":not("+c+")");var i=$(q).find("staff");$(i).each(function(){var r=this;if($.inArray(Number($(r).attr("n")),m)===-1){var s=this.parentNode;s.removeChild(this)}})}if(q.localName==="measure"&&Number($(q).attr("n"))===d.end_n){g=false}}});return l};MeiLib.Alt=function(a,b){this.xmlID=a;this.altitems=[];this.parentID=b};MeiLib.Variant=function(a,c,b,d,e){this.xmlID=a;this.tagname=c;this.source=b;this.resp=d;this.n=e};MeiLib.MeiDoc=function(a){if(a){this.init(a)}};MeiLib.MeiDoc.prototype.init=function(a){this.xmlDoc=a;this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0];this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0];this.rich_score=$(this.rich_music).find("score")[0];this.parseSourceList();this.parseEditorList();this.parseALTs();this.initAltgroups();this.initSectionView()};MeiLib.MeiDoc.prototype.getRichScore=function(){return this.rich_score};MeiLib.MeiDoc.prototype.getPlainScore=function(){return this.plain_score};MeiLib.MeiDoc.prototype.getALTs=function(){return this.ALTs};MeiLib.MeiDoc.prototype.getSourceList=function(){return this.sourceList};MeiLib.MeiDoc.prototype.getEditorList=function(){return this.editorList};MeiLib.MeiDoc.prototype.parseSourceList=function(){this.sources=$(this.rich_head).find("sourceDesc").children();return this.sources};MeiLib.MeiDoc.prototype.parseEditorList=function(){this.editors=$(this.rich_head).find("titleStmt").children("editor");return this.editors};MeiLib.MeiDoc.prototype.parseALTs=function(){this.ALTs={};var b=$(this.rich_score).find("app, choice");for(var h=0;h<b.length;h++){var d=b[h];var m=d.parentNode;var e=$(d).find("rdg, lem, sic, corr");var l=new MeiLib.Alt(MeiLib.XMLID(d),MeiLib.XMLID(m));l.altitems={};for(var g=0;g<e.length;g++){var k=e[g];var a=$(k).attr("source");var f=$(k).attr("resp");var c=$(k).attr("n");var p=$(k).prop("localName");var o=MeiLib.XMLID(k);l.altitems[o]=new MeiLib.Variant(o,p,a,f,c)}this.ALTs[MeiLib.XMLID(d)]=l}};MeiLib.MeiDoc.prototype.initAltgroups=function(){var c=this.ALTs;annots=$(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]');this.altgroups={};for(var b=0;b<annots.length;b++){altgroup=[];token_list=$(annots[b]).attr("plist").split(" ");for(var a in token_list){altgroup.push(token_list[a].replace("#",""))}for(var a in altgroup){this.altgroups[altgroup[a]]=altgroup}}};MeiLib.MeiDoc.prototype.initSectionView=function(b){b=b||{};this.sectionview_score=this.rich_score.cloneNode(true);this.sectionplane={};var h=$(this.sectionview_score).find("app, choice");var d;var g;var c=this.sectionview_score;var e=this.sectionplane;var a=this.ALTs;var f=this.xmlDoc;$(h).each(function(o,p){var l=MeiLib.XMLID(p);var k=b[l];if(k){g=k.xmlID;var m=$(this_score).find(k.tagname+'[xml\\:id="'+g+'"]')[0];if(!m){throw new MeiLib.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+g+"'.")}d=m.childNodes}else{if(p.localName==="choice"){var r=$(p).find("corr")[0];if(r){g=MeiLib.XMLID(r);d=r.childNodes}else{var j=$(p).find("sic")[0];if(j){g=MeiLib.XMLID(j);d=j.childNodes}else{d=[]}}}else{var q=$(p).find("lem")[0];if(q){g=MeiLib.XMLID(q);d=q.childNodes}else{d=[]}}}var t=p.parentNode;var s=f.createProcessingInstruction("MEI2VF",'rdgStart="'+l+'"');t.insertBefore(s,p);$.each(d,function(){t.insertBefore(this.cloneNode(true),p)});var n=f.createProcessingInstruction("MEI2VF",'rdgEnd="'+l+'"');t.insertBefore(n,p);t.removeChild(p);e[l]=a[l].altitems[g]});return this.sectionview_score};MeiLib.MeiDoc.prototype.updateSectionView=function(c){var d=function(h,g){var f=function(n,m){var k=0;for(var l in n){if(n[l]!==undefined&&n[l]===m[l]){k++}}console.log("vars_match: "+k);return k};var e=0;var j;for(var i in h){M=f(h[i],g);if(e<M){e=M;j=h[i]}}return j};for(altID in c){var b=this.ALTs[altID].altitems[c[altID]];altgroup=this.altgroups[altID];if(altgroup){for(var a in altgroup){altID__=altgroup[a];alt_instance2insert__=d(this.ALTs[altID__].altitems,b);this.replaceAltInstance({appXmlID:altID__,replaceWith:alt_instance2insert__})}}else{this.replaceAltInstance({appXmlID:altID,replaceWith:b})}}};MeiLib.MeiDoc.prototype.replaceAltInstance=function(e){var f=e.appXmlID;var g=[];if(e.replaceWith){var j=e.replaceWith.xmlID;var k=$(this.rich_score).find(e.replaceWith.tagname+'[xml\\:id="'+j+'"]')[0];g=k.childNodes}var b=function(m,n){m=m.replace("'",'"');n=n.replace("'",'"');return m===n};var h=$(this.sectionview_score).find("[xml\\:id="+this.ALTs[f].parentID+"]")[0];var c=h.childNodes;var a=false;var l=false;var i=null;$(c).each(function(){var m=this;if(m.nodeType===7){if(m.nodeName==="MEI2VF"&&b(m.nodeValue,'rdgStart="'+f+'"')){a=true;l=true}else{if(m.nodeName==="MEI2VF"&&b(m.nodeValue,'rdgEnd="'+f+'"')){a=false;i=m}}}else{if(a){h.removeChild(m)}}});if(!l){throw"processing instruction not found"}if(a){throw"Unmatched <?MEI2VF rdgStart?>"}var d;if(i){d=function(m){h.insertBefore(m,i)}}else{d=function(m){h.appendChild(m)}}$.each(g,function(){d(this.cloneNode(true))});this.sectionplane[f]=e.replaceWith;return this.sectionview_score};MeiLib.MeiDoc.prototype.getSectionViewSlice=function(a){return MeiLib.SliceMEI(this.sectionview_score,a)};MeiLib.MeiDoc.prototype.getRichSlice=function(b){var a=new MeiLib.MeiDoc();a.xmlDoc=this.xmlDoc;a.rich_head=this.rich_head.cloneNode();a.rich_music=this.rich_music.cloneNode();a.rich_score=MeiLib.SliceMEI(this.rich_score,b);a.sourceList=this.sourceList;a.editorList=this.editorList;a.ALTs=this.ALTs;a.altgroups=this.altgroups;return a};mei2vexflowTables={};mei2vexflowTables.positions={"above":Vex.Flow.Modifier.Position.ABOVE,"below":Vex.Flow.Modifier.Position.BELOW};mei2vexflowTables.hairpins={"cres":Vex.Flow.StaveHairpin.type.CRESC,"dim":Vex.Flow.StaveHairpin.type.DECRESC};mei2vexflowTables.articulations={"acc":"a>","stacc":"a.","ten":"a-","stacciss":"av","marc":"a^","dnbow":"am","upbow":"a|","snap":"ao","lhpizz":"a+","dot":"a.","stroke":"a|"};Node.prototype.attrs=function(){var b;var a={};for(b in this.attributes){a[this.attributes[b].name]=this.attributes[b].value}return a};Array.prototype.all=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===false){return false}}return true};Array.prototype.any=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===true){return true}}return false};MEI2VF={};MEI2VF.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};MEI2VF.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};MEI2VF.render_notation=function(G,V,at,p,x){var at=at||800;var p=p||350;var N;var a;var ax=13;var ae;var ar=[];var q=[];var aw=[];var R=[];var k={};var f=[];var aj=[];var E=[];var C=[];var ai=[];var ag=50;var aE=20;var aD=0;var an=aE;var A=0;var H=0;var aA=0;var b=false;var af=true;var O=new Array();var av=[];var aG=0;var h={};var F=new MEI2VF.StaveVoices();var Q=function(aI){Vex.Log("count_measures_siblings_till_sb() {}");if(aI.length===0){return 0}switch($(aI).prop("localName")){case"measure":return 1+Q($(aI).next());case"sb":return 0;default:return Q($(aI).next())}};var Z=function(aI){N=Q(aI);a=Math.round((at-aE)/N);Vex.LogDebug("update_measure_width(): "+N+", width:"+a)};var r=function(aI){Z(aI);Vex.LogDebug("startSystem() {enter}");if(af){aA=0;an=aE;H+=1;aD=A+ag*(aD>0?1:0);af=false;b=false;$.each(O,function(aJ,aK){if(aK){aK.renderWith.clef=true;aK.renderWith.keysig=true;aK.renderWith.timesig=true}})}else{if(b){aA=0;an=aE;H+=1;aD=A+ag;b=false;$.each(O,function(aJ,aK){if(aK){aK.renderWith.clef=true;aK.renderWith.keysig=true}})}}};var n=function(){if(ar[ar.length-1]){var aI=ar[ar.length-1][0];an=aI.x+aI.width;Vex.LogDebug("moveOneMeasure(): measure_left:"+an)}else{an=aE}};var P=function(){return(af||b)};var J=function(aJ,aK){var aI=ak(aJ,aK);if(!aI){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+aK+" is mandatory.")}return aI};var ak=function(aJ,aK){var aI=$(aJ).attr(aK);return aI};var I=function(aJ){aJ=(typeof aJ==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aJ;var aK=$(aJ).attr("pname");var aI=$(aJ).attr("oct");if(!aK||!aI){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>")}return aK+"/"+aI};var ay=function(aI){var aK=$(aI).find("syl");var aJ="";$(aK).each(function(aM,aN){var aO=($(aN).attr("wordpos")=="i"||$(aN).attr("wordpos")=="m")?"-":"";aJ+=(aM>0?"\n":"")+$(aN).text()+aO});var aL=(aK.attr("wordpos")=="i"||aK.attr("wordpos")=="m")?"-":"";return aJ};var s=function(aM,aJ){var aK=$(aM).find("dir");var aI="";var aL="";$(aK).each(function(){var aP=J(this,"startid");var aO=J(aJ,"xml:id");var aN=J(this,"place");if(aP===aO){aI+=$(this).text().trim();aL=aN}});return[aI,aL]};var U=function(aJ,aI){aJ={pitch:aJ.split("/")[0][0],octave:Number(aJ.split("/")[1])};aI={pitch:aI.split("/")[0][0],octave:Number(aI.split("/")[1])};if(aJ.octave===aI.octave){if(aJ.pitch===aI.pitch){return 0}else{if(aJ.pitch<aI.pitch){return -1}else{if(aJ.pitch>aI.pitch){return 1}}}}else{if(aJ.octave<aI.octave){return -1}else{if(aJ.octave>aI.octave){return 1}}}};var aB=function(aI){aI=String(aI);if(aI==="breve"){if(Vex.Flow.durationToTicks.durations["0"]!=undefined){return"0"}return"w"}if(aI==="1"){return"w"}if(aI==="2"){return"h"}if(aI==="4"){return"q"}if(aI==="8"){return"8"}if(aI==="16"){return"16"}if(aI==="32"){return"32"}if(aI==="64"){return"64"}throw new Vex.RuntimeError("BadArguments",'The MEI duration "'+aI+'" is not supported.')};var i=function(aI,aL){aL=aL||true;aI=(typeof aI==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aI;var aJ=$(aI).attr("dur");if(aJ===undefined){alert("Could not get duration from:\n"+JSON.stringify(aI,null,"\t"))}var aK=aB(aJ);if(aL===true&&$(aI).attr("dots")==="1"){aK+="d"}return aK};var W=function(aI){if(aI==="n"){return"n"}if(aI==="f"){return"b"}if(aI==="s"){return"#"}if(aI==="ff"){return"bb"}if(aI==="ss"){return"##"}throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+aI)};var Y=function(aJ,aI){var aK=$(aJ).attr("stem.dir");if(aK!==undefined){return(aK==="up")?Vex.Flow.StaveNote.STEM_UP:(aK==="down")?Vex.Flow.StaveNote.STEM_DOWN:undefined}else{var aL=K($(aI).attr("n"));if(aL==="treble"){return(U("a/5",I(aJ))===1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}else{if(aL==="octave"){return(U("a/4",I(aJ))===1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}else{if(aL==="bass"){return(U("c/3",I(aJ))===-1)?Vex.Flow.StaveNote.STEM_DOWN:Vex.Flow.StaveNote.STEM_UP}}}}};var aq=function(aI){if($(aI).attr("key.pname")!==undefined){var aL=$(aI).attr("key.pname").toUpperCase();var aK=$(aI).attr("key.accid");if(aK!==undefined){switch(aK){case"s":aL+="#";break;case"f":aL+="b";break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}}var aJ=$(aI).attr("key.mode");if(aJ!==undefined){aL+=aJ==="major"?"":"m"}return aL}else{return"C"}};var g=function(aI){var aJ=J(aI,"clef.shape");var aM=ak(aI,"clef.line");var aK=ak(aI,"clef.dis");var aL=ak(aI,"clef.dis.place");if(aJ==="G"&&(!aM||aM==="2")){if(aK==="8"&&aL==="below"&&Vex.Flow.clefProperties.values["octave"]!=undefined){return"octave"}return"treble"}else{if(aJ==="F"&&(!aM||aM==="4")){return"bass"}else{if(aJ==="C"&&aM==="3"){return"alto"}else{if(aJ==="C"&&aM==="4"){return"tenor"}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+aJ+'" '+(aM?('clef.line="'+aM+'"'):"")+" ]")}}}}};var K=function(aI){if(aI>=O.length){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.staff_clef():E01","No staff definition for staff n="+aI)}var aJ=O[aI].staffDef;return g(aJ)};var aH=function(aI){if($(aI).attr("meter.count")!==undefined&&$(aI).attr("meter.unit")!==undefined){return $(aI).attr("meter.count")+"/"+$(aI).attr("meter.unit")}};var am=function(aJ){var aI=new Vex.Flow.Renderer(aJ,x||Vex.Flow.Renderer.Backends.CANVAS);ae=aI.getContext()};var y=function(aI){return 100};var l=function(aK){var aI=0;var aJ;for(aJ=0,exit=0;aJ<av.length&&!exit;aJ++){if($(av[aJ]).attr("n")!==aK.toString()){aI+=y(aJ)}else{exit=true}}return aI};var j=function(aK){var aI=aD+l(aK);var aJ=aI+y(aK);if(aJ>A){A=aJ}return aI};var ah=function(aK,aJ){if(!aK){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".')}var aL=O[aK].staffDef;var aI=new Vex.Flow.Stave(an,j(aK),aJ);if(O[aK].renderWith.clef){if($(aL).attr("clef.visible")==="true"||$(aL).attr("clef.visible")===undefined){aI.addClef(g(aL));O[aK].renderWith.clef=false}}if(O[aK].renderWith.keysig){if($(aL).attr("key.sig.show")==="true"||$(aL).attr("key.sig.show")===undefined){aI.addKeySignature(aq(aL))}O[aK].renderWith.keysig=false}if(O[aK].renderWith.timesig){if($(aL).attr("meter.rend")==="norm"||$(aL).attr("meter.rend")===undefined){aI.addTimeSignature(aH(aL))}O[aK].renderWith.timesig=false}aI.setContext(ae).draw();aG=aI.bar_x_shift;Vex.LogDebug("initialise_staff_n(): staffXShift="+aG);return aI};var al=function(){var aI=$(G).find("scoreDef")[0];if(!aI){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found.")}u(aI);$(G).find("section").children().each(T);$.each(aw,function(aK,aJ){aJ.setContext(ae).draw()});S(aj);S(E);aF(C)};var S=function(aI){$(aI).each(function(aM,aN){var aK=k[aN.getFirstId()];var aO=k[aN.getLastId()];var aL;if(aK){aL=aK.vexNote}var aJ;if(aO){aJ=aO.vexNote}new Vex.Flow.StaveTie({first_note:aL,last_note:aJ}).setContext(ae).draw()})};var aF=function(aI){$(aI).each(function(aL,aQ){var aR=k[aQ.getFirstId()];var aN=k[aQ.getLastId()];var aP;if(aR){aP=aR.vexNote}var aJ;if(aN){aJ=aN.vexNote}var aK=mei2vexflowTables.positions[aQ.params.place];var aO=mei2vexflowTables.hairpins[aQ.params.form];var aM=0;var aT=0;var aS={height:10,y_shift:0,left_shift_px:aM,r_shift_px:aT};new Vex.Flow.StaveHairpin({first_note:aP,last_note:aJ,},aO).setContext(ae).setRenderOptions(aS).setPosition(aK).draw()})};var az=function(){for(var aL in h){var aM=h[aL];var aI=aM.vexType();var aJ=f[aM.top_staff_n];var aK=f[aM.bottom_staff_n];if(aI&&aJ&&aK){var aN=new Vex.Flow.StaveConnector(aJ,aK);aN.setType(aM.vexType());aN.setContext(ae);aN.draw()}}};var T=function(aI,aK){switch($(aK).prop("localName")){case"measure":var aJ;if(P()){r(aK);aJ=true}else{n();aJ=false}F.reset();v(aK);if(aJ){az();aJ=false}F.format(a-aG-20);F.draw(ae,f);aC(aK,"tie",aj);aC(aK,"slur",E);aC(aK,"hairpin",C);break;case"scoreDef":u(aK);break;case"staffDef":z(aK);break;case"sb":ad(aK);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aK).prop("localName")+"> is not supported in <section>")}};var ad=function(aI){b=true};var u=function(aI){av.length=0;$(aI).children().each(ab)};var ab=function(aI,aJ){switch($(aJ).prop("localName")){case"staffGrp":c(aJ);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aJ).prop("localName")+"> is not supported in <scoreDef>")}};var c=function(aK){var aI={};var aJ=aK.attrs().symbol;$(aK).children().each(function(aM,aN){var aL=ao(aM,aN);Vex.LogDebug("process_staffGrp() {1}.{a}: local_result.first_n:"+aL.first_n+" local_result.last_n:"+aL.last_n);if(aM===0){aI.first_n=aL.first_n;aI.last_n=aL.last_n}else{aI.last_n=aL.last_n}});Vex.LogDebug("process_staffGrp() {2}: symbol:"+aJ+" result.first_n:"+aI.first_n+" result.last_n:"+aI.last_n);h[aI.first_n.toString()+":"+aI.last_n.toString()]=new MEI2VF.StaveConnector(aJ,aI.first_n,aI.last_n);return aI};var ao=function(aI,aK){switch($(aK).prop("localName")){case"staffDef":var aJ=z(aK);return{first_n:aJ,last_n:aJ};break;case"staffGrp":return c(aK);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aK).prop("localName")+"> is not supported in <staffGrp>")}};var z=function(aI){var aJ=Number(aI.attrs().n);var aK=O[aJ];if(aK){O[aJ].updateDef(aI)}else{O[aJ]=new MEI2VF.StaffInfo(aI,true,true,true)}av.push(aI);return aJ};var v=function(aI){ar.push($(aI).find("staff").map(function(aK,aJ){return ap(aK,aJ,aI)}).get())};var ap=function(aL,aO,aN){var aR,aJ,aQ;var aK=Number(aO.attrs().n);var aI=Number(aN.attrs().n);aR=ah(aK,a);var aP=$(aO).find("layer").map(function(aT,aS){return aa(aT,aS,aO,aN)}).get();var aM=[];$(aP).each(function(){var aS=$(this.events).get().map(function(aT){return aT.vexNote?aT.vexNote:aT});F.addVoice(X(null,aS),aK)});f[aK]=aR;if(q[aI]===undefined){q[aI]=[]}q[aI][aK]=aR;return aR};var aa=function(aL,aM,aO,aN){var aI=aN.attrs().n;if(!aI){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_events:","<measure> must have @n specified")}var aK=aO.attrs().n;if(!aK){aK="1"}var aJ=aM.attrs().n;if(!aJ){aJ="1"}var aP=O[aK].staffDef;var aQ=aI+":"+aK+":"+aJ;if(ai[aQ]){$(ai[aQ]).each(function(aR,aS){var aU=$(aP).attr("meter.count");var aT=$(aP).attr("meter.unit");var aV={count:Number(aU),unit:Number(aT)};aS.setContext({layer:aM,meter:aV});ai[aQ][aR]=null});ai[aQ]=null}return{layer:aL,events:$(aM).children().map(function(aS,aR){return L(aR,aM,aO,aN)}).get()}};var aC=function(aO,aP,aK){var aI=function(aS){var aR=aS.attrs().staff;if(!aR){aR="1"}var aQ=aS.attrs().layer;if(!aQ){aQ="1"}return{staff_n:aR,layer_n:aQ}};var aJ=function(aU,aS,aQ){var aW=aI(aS);var aY=$(aQ).find('staff[n="'+aW.staff_n+'"]');var aT=$(aY).find('layer[n="'+aW.layer_n+'"]').get(0);if(!aT){var aX=$(aY).find("layer");if(aX&&!aX.attr("n")){aT=aX}if(!aT){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}}var aV=O[aW.staff_n].staffDef;if(!aV){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.")}var aR={count:Number(aV.attrs()["meter.count"]),unit:Number(aV.attrs()["meter.unit"])};if(!aR.count||!aR.unit){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.")}return MeiLib.tstamp2id(aU,aT,aR)};var aN=function(aR){var aQ;return aR.substring(0,aR.indexOf("m"))};var aL=function(aR){var aQ;return aR.substring(aR.indexOf("+")+1)};var aM=$(aO).find(aP);$.each(aM,function(a0,aY){var aT=new MEI2VF.EventLink(null,null);if(aP==="hairpin"){var aS=aY.attrs().form;if(!aS){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.")}var aW=aY.attrs().place;aT.setParams({form:aS,place:aW})}var aV=aY.attrs().startid;if(aV){aT.setFirstId(aV)}else{var a1=aY.attrs().tstamp;if(a1){aV=aJ(a1,aY,aO);aT.setFirstId(aV)}else{}}var aZ=aY.attrs().endid;if(aZ){aT.setLastId(aZ)}else{var aX=aY.attrs().tstamp2;if(aX){var aU=Number(aN(aX));if(aU>0){aT.setLastTStamp(aL(aX));var aR=aI(aY);var aQ=aO.attrs().n;var a2=Number(aQ)+aU;var a3=a2.toString()+":"+aR.staff_n+":"+aR.layer_n;if(!ai[a3]){ai[a3]=new Array()}ai[a3].push(aT)}else{aZ=aJ(aL(aX),aY,aO);aT.setLastId(aZ)}}else{}}aK.push(aT)})};var t=function(aL,aK,aI){var aJ=new MEI2VF.EventLink(aL,aK);aI.push(aJ)};var w=function(aL,aI,aJ){var aK=new MEI2VF.EventLink(aL,null);aK.setParams({linkCond:aI});aJ.push(aK)};var B=function(aN,aI){var aJ=function(aP,aO){return(aP&&aO&&aP.pname===aO.pname&&aP.oct===aO.oct&&aP.system===aO.system)};if(!aI.pname||!aI.oct){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or specified for the tie")}var aM=false;var aK;var aL;for(aK=0;!aM&&aK<aj.length;++aK){aL=aj[aK];if(!aL.getLastId()){if(aJ(aL.params.linkCond,aI)){aM=true;aL.setLastId(aN)}else{}}}if(!aM){var aL=new MEI2VF.EventLink(null,aN);aj.push(aL)}};var e=function(aO,aI){var aK=function(aQ,aP){return aQ.nesting_level===aP.nesting_level&&aQ.system===aP.system};var aN=false;var aM=0;var aJ;for(aM=0;!aN&&aM<E.length;++aM){var aL=E[aM];if(aL&&!aL.getLastId()&&aK(aL.params.linkCond,aI)){aN=true;aL.setLastId(aO)}}if(!aN){var aL=new MEI2VF.EventLink(null,aO);E.push(aL)}};var d=function(aJ){var aI=[];var aK=aJ.split(" ");$.each(aK,function(aM,aN){var aL;if(aN.length===1){aI.push({letter:aN,nesting_level:0})}else{if(aN.length===2){if(!(aL=Number(aN[1]))){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}aI.push({letter:aN[0],nesting_level:aL})}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}}});return aI};var m=function(aJ,aO,aZ,aQ){var aX=function(a0){return(new Vex.Flow.Annotation(a0)).setFont("Times",ax).setBottom(true)};var aI=function(a0){return(new Vex.Flow.Annotation(a0)).setFont("Times",ax)};try{var aL=new Vex.Flow.StaveNote({keys:[I(aJ)],clef:K($(aZ).attr("n")),duration:i(aJ),stem_direction:Y(aJ,aZ)});aL.addAnnotation(2,aX(ay(aJ)));var aR=s(aQ,aJ);aL.addAnnotation(2,aR[1]=="below"?aX(aR[0]):aI(aR[0]));try{var aY;for(aY=0;aY<parseInt($(aJ).attr("dots"));aY++){aL.addDotToAll()}}catch(aS){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the dots of <note>: "+JSON.stringify(aJ.attrs())+'. "'+aS.toString()+'"')}var aN=$(aJ).attr("accid");if(aN){aL.addAccidental(0,new Vex.Flow.Accidental(W(aN)))}$.each($(aJ).find("artic"),function(a1,a0){aL.addArticulation(0,new Vex.Flow.Articulation(mei2vexflowTables.articulations[$(a0).attr("artic")]).setPosition(mei2vexflowTables.positions[$(a0).attr("place")]))});$.each($(aJ).children(),function(a0,a1){$(a1).remove()});var aP=$(aJ).attr("xml:id");if(!aP){aP=MeiLib.createPseudoUUID();$(aJ).attr("xml:id",aP)}var aT=$(aJ).attr("tie");if(!aT){aT=""}var aK=$(aJ).attr("pname");if(!aK){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute")}var aW=$(aJ).attr("oct");if(!aW){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute")}for(var aY=0;aY<aT.length;++aY){switch(aT[aY]){case"i":w(aP,{pname:aK,oct:aW,system:H},aj);break;case"t":B(aP,{pname:aK,oct:aW,system:H});break}}var aM=$(aJ).attr("slur");if(aM){var aU=d(aM);$.each(aU,function(a1,a0){switch(a0.letter){case"i":w(aP,{nesting_level:a0.nesting_level,system:H},E);break;case"t":e(aP,{nesting_level:a0.nesting_level,system:H});break}})}var aV={vexNote:aL,id:aP};R.push(aV);k[aP]={meiNote:aJ,vexNote:aL};return aV}catch(aS){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <note>: "+JSON.stringify(aJ.attrs())+'. "'+aS.toString()+'"')}};var ac=function(aL,aK,aJ,aO,aN){if(aN==undefined){aN=true}try{if(aN){var aM=new Vex.Flow.StaveNote({keys:["c/5"],duration:i(aL,false)+"r"});if($(aL).attr("dots")==="1"){aM.addDotToAll()}}else{var aM=new Vex.Flow.GhostNote({duration:i(aL,false)+"r"})}return aM}catch(aI){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <rest>: "+JSON.stringify(aL.attrs())+'. "'+aI.toString()+'"')}};var au=function(aL,aK,aJ,aN){try{var aM=new Vex.Flow.StaveNote({keys:["c/5"],duration:"wr"});return aM}catch(aI){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <mRest>: "+JSON.stringify(aL.attrs())+'. "'+aI.toString()+'"')}};var o=function(aK,aJ,aI,aM){var aL=$(aK).children().map(function(aN,aO){var aP=L(aO,aJ,aI,aM);return aP.vexNote?aP.vexNote:aP}).get();aw.push(new Vex.Flow.Beam(aL));return aL};var D=function(aL,aI,aO,aN){try{var aQ=$(aL).children().map(I).get();var aJ=aB(Math.max.apply(Math,$(aL).children().map(function(){return Number($(this).attr("dur"))}).get()));var aM=$(aL).children().map(function(){return $(this).attr("dots")==="1"}).get().any();if(aM===true){aJ+="d"}var aK=new Vex.Flow.StaveNote({keys:aQ,clef:K($(aO).attr("n")),duration:aJ});if(aM===true){aK.addDotToAll()}$(aL).children().each(function(aS,aT){var aR=$(aT).attr("accid");if(aR!==undefined){aK.addAccidental(aS,new Vex.Flow.Accidental(W(aR)))}});return aK}catch(aP){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <chord>:"+aP.toString())}};var L=function(aK,aJ,aI,aM){var aL=$(aK).prop("localName");if(aL==="rest"){return ac(aK,aJ,aI,aM)}else{if(aL==="mRest"){return au(aK,aJ,aI,aM)}else{if(aL==="space"){return ac(aK,aJ,aI,aM,false)}else{if(aL==="note"){return m(aK,aJ,aI,aM)}else{if(aL==="beam"){return o(aK,aJ,aI,aM)}else{if(aL==="chord"){return D(aK,aJ,aI,aM)}else{throw new Vex.RuntimeError("BadArguments",'Rendering of element "'+aL+'" is not supported.')}}}}}}};var X=function(aJ,aI){if(!$.isArray(aI)){throw new Vex.RuntimeError("BadArguments","make_voice() voice_contents argument must be an array.")}var aK=new Vex.Flow.Voice({num_beats:Number($(G).find("staffDef").attr("meter.count")),beat_value:Number($(G).find("staffDef").attr("meter.unit")),resolution:Vex.Flow.RESOLUTION});aK.setStrict(false);aK.addTickables(aI);return aK};am(V);al();MEI2VF.rendered_measures=q};MEI2VF.EventLink=function(b,a){this.init(b,a)};MEI2VF.EventLink.prototype.init=function(b,a){this.first_ref=new MEI2VF.EventReference(b);this.last_ref=new MEI2VF.EventReference(a);this.params={}};MEI2VF.EventLink.prototype.setParams=function(a){this.params=a};MEI2VF.EventLink.prototype.setFirstRef=function(a){this.first_ref=a};MEI2VF.EventLink.prototype.setLastRef=function(a){this.last_ref=a};MEI2VF.EventLink.prototype.setFirstId=function(a){this.first_ref.setId(a)};MEI2VF.EventLink.prototype.setLastId=function(a){this.last_ref.setId(a)};MEI2VF.EventLink.prototype.setFirstTStamp=function(a){this.first_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setLastTStamp=function(a){this.last_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setContext=function(a){this.meicontext=a};MEI2VF.EventLink.prototype.getFirstId=function(){return this.first_ref.getId({meicontext:this.meicontext})};MEI2VF.EventLink.prototype.getLastId=function(){return this.last_ref.getId({meicontext:this.meicontext})};MEI2VF.EventReference=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setId=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setTStamp=function(a){this.tstamp=a;if(this.xmlid){this.tryResolveReference(true)}};MEI2VF.EventReference.prototype.tryResolveReference=function(b){var a=this.tstamp;var c=this.meicontext;if(!a){throw new MEI2VF.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.")}if(this.meicontext){this.xmlid=MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter)}else{this.xmlid=null}};MEI2VF.EventReference.prototype.getId=function(a){if(a&&a.meicontext){this.setContext(a.meicontext)}if(this.xmlid){return this.xmlid}if(this.tstamp){if(this.meicontext){this.tryResolveReference(a&&a.strict);return this.xmlid}}return null};MEI2VF.EventReference.prototype.setContext=function(a){this.meicontext=a};MEI2VF.StaffInfo=function(b,d,c,a){this.renderWith={clef:d,keysig:c,timesig:a};this.staffDef=b};MEI2VF.StaffInfo.prototype.look4changes=function(c,d){var a={clef:false,keysig:false,timesig:false};if(!c&&d){a.clef=true;a.keysig=true;a.keysig=true;return a}else{if(c&&!d){a.clef=false;a.keysig=false;a.keysig=false;return a}else{if(!c&&!d){throw new MEI2VF_RUNTIME_ERROR("BadArgument","Cannot compare two undefined staff definitions.")}}}var b=function(g,e,f){return $(g).attr(f)===$(e).attr(f)};if(!b(c,d,"clef.shape")||!b(c,d,"clef.line")){a.clef=true}if((!b(c,d,"key.pname")||!b(c,d,"key.accid")||!b(c,d))){a.keysig=true}if(!b(c,d,"meter.count")||!b(c,d,"meter.unit")){a.timesig=true}return a};MEI2VF.StaffInfo.prototype.updateDef=function(a){this.renderWith=this.look4changes(this.staffDef,a);this.staffDef=a};MEI2VF.StaveConnector=function(b,a,c){this.init(b,a,c)};MEI2VF.StaveConnector.prototype.init=function(b,a,c){this.symbol=b;this.top_staff_n=a;this.bottom_staff_n=c};MEI2VF.StaveConnector.prototype.vexType=function(){switch(this.symbol){case"line":return Vex.Flow.StaveConnector.type.SINGLE;case"brace":return Vex.Flow.StaveConnector.type.BRACE;case"bracket":return Vex.Flow.StaveConnector.type.BRACKET;case"none":return null;default:return Vex.Flow.StaveConnector.type.SINGLE}};MEI2VF.StaffVoice=function(b,a){this.voice=b;this.staff_n=a};MEI2VF.StaveVoices=function(){this.all_voices=new Array()};MEI2VF.StaveVoices.prototype.addStaffVoice=function(a){this.all_voices.push(a)};MEI2VF.StaveVoices.prototype.addVoice=function(b,a){this.addStaffVoice(new MEI2VF.StaffVoice(b,a))};MEI2VF.StaveVoices.prototype.reset=function(){this.all_voices=[]};MEI2VF.StaveVoices.prototype.format=function(b){var a=$.map(this.all_voices,function(d,c){return d.voice});new Vex.Flow.Formatter().format(a,b)};MEI2VF.StaveVoices.prototype.draw=function(d,e){var c=this.all_voices;var b;for(var a=0;a<c.length;++a){b=c[a];b.voice.draw(d,e[b.staff_n])}};