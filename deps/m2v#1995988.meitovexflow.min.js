/*! meitovexflow 2014-05-02 */
var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a,this.message=b},MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""},MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)},MeiLib.EventEnumerator=function(a){this.init(a)},MeiLib.EventEnumerator.prototype.init=function(a){if(!a)throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");this.node=a,this.next_evnt=null,this.EoI=!0,this.children=$(this.node).children(),this.i_next=-1,this.read_ahead()},MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;return this.read_ahead(),a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")},MeiLib.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()},MeiLib.EventEnumerator.prototype.step_ahead=function(){if(++this.i_next,this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");"note"===a||"rest"===a||"mRest"===a||"chord"===a?this.EoI=!1:"beam"===a&&(this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1))}else this.EoI=!0},MeiLib.durationOf=function(a,b){IsSimpleEvent=function(a){return"note"===a||"rest"===a||"space"===a};var c=function(a,b){var c=$(a).attr("dur");if(!c)throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <b>note</b>, <b>rest</b> or <b>space</b> must be specified.");return MeiLib.dotsMult(a)*MeiLib.dur2beats(Number(c),b)},d=function(a,b,c){c||(c="1");var d=$(a).attr("dur"),e=MeiLib.dotsMult(a);if(d)return e*MeiLib.dur2beats(Number(d),b);if($(a).find("note").each(function(){if(lyr_n=$(this).attr("layer"),!lyr_n||lyr_n===c){var b=$(this).attr("dur"),f=MeiLib.dotsMult(a);if(!d&&b)d=b,e=f;else if(d&&d!=b)throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}),d)return e*MeiLib.dur2beats(Number(d),b);throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")},e=function(a,b){var e=0;return a.children().each(function(){var a,f=this.prop("localName");if(IsSimpleEvent(f))a=c(this,b);else{if("chord"!==f)throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+f+"'");a=d(this,b)}e+=a}),e},f=$(a).prop("localName");if(IsSimpleEvent(f))return c(a,b);if("mRest"===f)return b.count;if("chord"===f)return d(a,b);if("beam"===f)return e(a,b);throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+f+"'")},MeiLib.tstamp2id=function(a,b,c){for(var d,e,f,g,h=Number(a),i=0,j=function(){return i+1},k=function(){return h-j()},l=new MeiLib.EventEnumerator(b);!l.EoI&&(void 0===e||e>0);)f=d,g=e,d=l.nextEvent(),e=k(),i+=MeiLib.durationOf(d,c);if(void 0===e)return void 0;var m;m=0>e?f&&g<Math.abs(e)?f:d:d;var n;return n=$(m).attr("xml:id"),n||(n=MeiLib.createPseudoUUID(),$(m).attr("xml:id",n)),n},MeiLib.XMLID=function(a){return xml_id=$(a).attr("xml:id"),xml_id||(xml_id=MeiLib.createPseudoUUID(),$(a).attr("xml:id",xml_id)),xml_id},MeiLib.id2tstamp=function(a,b){for(var c,d=!1,e=0;e<b.length&&!d;++e){if(b[e].meter&&(c=b[e].meter),0===e&&!c)throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var f=MeiLib.sumUpUntil(a,b[e].layer,c);if(f.found)return d=!0,e.toString()+"m+"+(f.beats+1).toString()}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+a+'" was found in the given MEI context.')},MeiLib.dur2beats=function(a,b){return b.unit/a},MeiLib.beats2dur=function(a,b){return b.unit/a},MeiLib.dotsMult=function(a){var b=$(a).attr("dots");b=Number(b||"0");for(var c=1;b>0;--b)c+=1/Math.pow(2,b);return c},MeiLib.sumUpUntil=function(a,b,c){var d=function(b){var e,f,g,h,i,j,k,l,m=$(b),n=m.prop("localName");if("note"===n||"rest"===n){if(m.attr("xml:id")===a)return{beats:0,found:!0};if(h=Number(m.attr("dur")),!h)throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");return i=m.attr("dots"),i=Number(i||"0"),e=MeiLib.dotsMult(m)*MeiLib.dur2beats(h,c),{beats:e,found:!1}}if("mRest"===n)return m.attr("xml:id")===a?(g=!0,{beats:0,found:!0}):{beats:c.count,found:!1};if("layer"===n||"beam"===n){for(e=0,f=m.children(),g=!1,l=0;l<f.length&&!g;++l)j=d(f[l]),e+=j.beats,g=j.found;return{beats:e,found:g}}if("chord"===n){if(k=m.attr("dur"),m.attr("xml:id")===a)return{beats:0,found:!0};if(k=m.attr("dur"))return m.find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:MeiLib.dur2beats(k,c),found:g};for(f=m.children(),g=!1,l=0;l<f.length&&!g;++l)j=d(f[l]),e=j.beats,g=j.found;return{beats:e,found:g}}return{beats:0,found:!1}};return d(b)},MeiLib.SliceMEI=function(a,b){var c=function(a,b){$.each(a,function(a,c){b.noClef&&$(c).attr("clef.visible","false"),b.noKey&&$(c).attr("key.sig.show","false"),b.noMeter&&$(c).attr("meter.rend","false")})},d=b.staves;if(d)for(var e="",f="",g="",h=0;h<d.length;h++)e+=g+'[n="'+d[h]+'"]',f+=g+'[staff="'+d[h]+'"]',0===h&&(g=", ");var i,j=a.cloneNode(!0);if(d&&$(j).find("staffDef").remove(":not("+e+")"),b.noClef||b.noKey||b.noMeter){var k=$(j).find("staffDef");i=$(j).find("scoreDef"),c(i,b),c(k,b)}b.noConnectors&&$(j).find("staffGrp").removeAttr("symbol");var l=$(j).find("section")[0],m=!1,n=!1,o=l.childNodes;return $(o).each(function(){var a=this;if(m||("measure"===a.localName&&Number($(a).attr("n"))===b.start_n?(m=!0,n=!0):l.removeChild(a)),m){if(d){$(a).find("[staff]").remove(":not("+f+")");var c=$(a).find("staff");$(c).each(function(){var a=this;if(-1===$.inArray(Number($(a).attr("n")),d)){var b=this.parentNode;b.removeChild(this)}})}"measure"===a.localName&&Number($(a).attr("n"))===b.end_n&&(m=!1)}}),j},MeiLib.Alt=function(a,b,c,d){this.elem=a,this.xmlID=b,this.altitems=[],this.parentID=c,this.tagname=d},MeiLib.Alt.prototype.getDefaultItem=function(){var a=function(a,b,c){var d;for(alt in a){if(a[alt].tagname===b)return a[alt];d||a[alt].tagname!==c||(d=a[alt])}return d};return"choice"===this.tagname?a(this.altitems,"corr","sic"):"app"===this.tagname?a(this.altitems,"lem"):void 0},MeiLib.Variant=function(a,b,c,d,e,f){this.elem=a,this.xmlID=b,this.tagname=c,this.source=d,this.resp=e,this.n=f},MeiLib.MeiDoc=function(a){a&&this.init(a)},MeiLib.MeiDoc.prototype.init=function(a){this.xmlDoc=a,this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0],this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0],this.rich_score=$(this.rich_music).find("score")[0],this.parseSourceList(),this.parseEditorList(),this.parseALTs(),this.initAltgroups(),this.initSectionView()},MeiLib.MeiDoc.prototype.getRichScore=function(){return this.rich_score},MeiLib.MeiDoc.prototype.getPlainScore=function(){return this.plain_score},MeiLib.MeiDoc.prototype.getALTs=function(){return this.ALTs},MeiLib.MeiDoc.prototype.getSourceList=function(){return this.sourceList},MeiLib.MeiDoc.prototype.getEditorList=function(){return this.editorList},MeiLib.MeiDoc.prototype.parseSourceList=function(){return this.sources=$(this.rich_head).find("sourceDesc").children(),this.sources},MeiLib.MeiDoc.prototype.parseEditorList=function(){return this.editors=$(this.rich_head).find("titleStmt").children("editor"),this.editors},MeiLib.MeiDoc.prototype.parseALTs=function(){var a,b;this.ALTs={};var c=$(this.rich_score).find("app, choice");for(a=0;a<c.length;a++){var d=c[a],e=d.parentNode,f=$(d).find("rdg, lem, sic, corr"),g=new MeiLib.Alt(d,MeiLib.XMLID(d),MeiLib.XMLID(e),d.localName);for(g.altitems={},b=0;b<f.length;b++){var h=f[b],i=$(h).attr("source"),j=$(h).attr("resp"),k=$(h).attr("n"),l=$(h).prop("localName"),m=MeiLib.XMLID(h);g.altitems[m]=new MeiLib.Variant(h,m,l,i,j,k)}this.ALTs[MeiLib.XMLID(d)]=g}},MeiLib.MeiDoc.prototype.initAltgroups=function(){{var a,b;this.ALTs}for(annots=$(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]'),this.altgroups={},a=0;a<annots.length;a++){for(altgroup=[],token_list=$(annots[a]).attr("plist").split(" "),b=0;b<token_list.length;b++)altgroup.push(token_list[b].replace("#",""));for(b in altgroup)this.altgroups[altgroup[b]]=altgroup}},MeiLib.MeiDoc.prototype.selectDefaultAlternative=function(a){var b={};if("choice"===a.localName){var c=$(a).find("corr")[0];if(c)b.alt_item_xml_id=MeiLib.XMLID(c),b.alt_item=c;else{var d=$(a).find("sic")[0];d?(b.alt_item_xml_id=MeiLib.XMLID(d),b.alt_item=d):b={}}}else{var e=$(a).find("lem")[0];e?(b.alt_item_xml_id=MeiLib.XMLID(e),b.alt_item=e):b={}}return b},MeiLib.MeiDoc.prototype.initSectionView=function(a){a=a||{},this.sectionview_score=this.rich_score.cloneNode(!0),this.sectionplane={};var b,c=$(this.sectionview_score).find("app, choice"),d=this.sectionview_score,e=this.sectionplane,f=this.ALTs,g=this.xmlDoc,h=this;return $(c).each(function(c,i){var j=MeiLib.XMLID(i),k=a[j];if(k){b=k.xmlID;var l=$(d).find(k.tagname+'[xml\\:id="'+b+'"]')[0];if(!l)throw new MeiLib.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+b+"'.")}else{var m=h.ALTs[j].getDefaultItem();m&&(b=m.xmlID,l=m.elem)}var n=i.parentNode,o=g.createProcessingInstruction("MEI2VF",'rdgStart="'+j+'"');if(n.insertBefore(o,i),l){var c,p=l.childNodes;for(c=0;c<p.length;++c)n.insertBefore(p.item(c).cloneNode(!0),i)}var q=g.createProcessingInstruction("MEI2VF",'rdgEnd="'+j+'"');n.insertBefore(q,i),n.removeChild(i),e[j]=[],f[j].altitems[b]&&e[j].push(f[j].altitems[b])}),this.sectionview_score},MeiLib.MeiDoc.prototype.updateSectionView=function(a){var b=function(a,b){var c,d=function(a,b){var c=0;for(var d in a)void 0!==a[d]&&a[d]===b[d]&&c++;return console.log("vars_match: "+c),c},e=0;for(var f in a)M=d(a[f],b),M>e&&(e=M,c=a[f]);return c};for(altID in a){var c=this.ALTs,d=[];if("string"==typeof a[altID]&&(a[altID]=[a[altID]]),a[altID].length>0)$(a[altID]).each(function(){d.push(c[altID].altitems[this])});else{var e=this.ALTs[altID].getDefaultItem();e&&d.push(e)}if(altgroup=this.altgroups[altID]){var f;for(f=0;f<altgroup.length;f++){altID__=altgroup[f];var g=[];$(d).each(function(){g.push(b(c[altID__].altitems,this))}),this.replaceAltInstance({appXmlID:altID__,replaceWith:g})}}else this.replaceAltInstance({appXmlID:altID,replaceWith:d})}},MeiLib.MeiDoc.prototype.replaceAltInstance=function(a){var b=function(a,b){var c,d=a;for(c=0;c<b.length;++c)d.push(b.item(c));return d},c=a.appXmlID,d=$(this.sectionview_score).find("[xml\\:id="+this.ALTs[c].parentID+"]")[0];if("undefined"!=typeof d){var e=d.childNodes,f=a.replaceWith,g=[],h=this.rich_score;if(f){var i;for(i=0;i<f.length;++i){var j=f[i],k=j.xmlID,l=$(h).find(j.tagname+'[xml\\:id="'+k+'"]')[0];g=b(g,l.childNodes)}}console.log(g);var m=function(a,b){return a=a.replace("'",'"'),b=b.replace("'",'"'),a===b},n=!1,o=!1,p=null;if($(e).each(function(){var a=this;7===a.nodeType?"MEI2VF"===a.nodeName&&m(a.nodeValue,'rdgStart="'+c+'"')?(n=!0,o=!0):"MEI2VF"===a.nodeName&&m(a.nodeValue,'rdgEnd="'+c+'"')&&(n=!1,p=a):n&&d.removeChild(a)}),!o)throw"processing instruction not found";if(n)throw"Unmatched <?MEI2VF rdgStart?>";var q;return q=p?function(a){d.insertBefore(a,p)}:function(a){d.appendChild(a)},$.each(g,function(){q(this.cloneNode(!0))}),this.sectionplane[c]=a.replaceWith,this.sectionview_score}},MeiLib.MeiDoc.prototype.getSectionViewSlice=function(a){return MeiLib.SliceMEI(this.sectionview_score,a)},MeiLib.MeiDoc.prototype.getRichSlice=function(a){var b=new MeiLib.MeiDoc;return b.xmlDoc=this.xmlDoc,b.rich_head=this.rich_head.cloneNode(!0),b.rich_music=this.rich_music.cloneNode(!0),b.rich_score=MeiLib.SliceMEI(this.rich_score,a),b.sourceList=this.sourceList,b.editorList=this.editorList,b.ALTs=this.ALTs,b.altgroups=this.altgroups,b};var MEI2VF=function(a,b,c,d){return a.Converter=function(a){return a&&this.initConfig(a),this},a.Converter.prototype={HALF_LINE_DISTANCE:5,BOTTOM:b.Annotation.VerticalJustify.BOTTOM,defaults:{page_width:800,page_margin_top:60,page_margin_left:20,page_margin_right:20,systemSpacing:90,staveSpacing:60,autoStaveConnectorLine:!0,labelMode:null,maxHyphenDistance:75,lyricsFont:{family:"Times",size:15},annotFont:{family:"Times",size:15,weight:"Italic"},tempoFont:{family:"Times",size:17,weight:"bold"},staff:{vertical_bar_width:20,top_text_position:1.5,bottom_text_position:7.5}},initConfig:function(b){var d=this;return d.cfg=c.extend(!0,{},d.defaults,b),d.systemInfo=new a.SystemInfo,d.printSpace={top:d.cfg.page_margin_top-40,left:d.cfg.page_margin_left,right:d.cfg.page_width-d.cfg.page_margin_right,width:Math.floor(d.cfg.page_width-d.cfg.page_margin_right-d.cfg.page_margin_left)-1},d},reset:function(){var b=this;return b.systemInfo.init(b.cfg,b.printSpace),b.systems=[],b.allVexMeasureStaffs=[],b.allBeams=[],b.ties=new a.Ties,b.slurs=new a.Ties,b.hairpins=new a.Hairpins,b.hyphenation=new a.Hyphenation(b.cfg.lyricsFont,b.printSpace.right,b.cfg.maxHyphenDistance),b.notes_by_id={},b.currentSystem_n=0,b.pendingSystemBreak=!1,b.pendingSectionBreak=!0,b.currentVoltaType=null,b.unresolvedTStamp2=[],b},process:function(a){var b=this;return b.reset(),b.systemInfo.processScoreDef(c(a).find("scoreDef")[0]),b.processSections(a),b.ties.createVexFromLinks(b.notes_by_id),b.slurs.createVexFromLinks(b.notes_by_id),b.hairpins.createVexFromLinks(b.notes_by_id),b},draw:function(a){var b=this;return b.drawSystems(a),b.drawVexBeams(b.allBeams,a),b.ties.setContext(a).draw(),b.slurs.setContext(a).draw(),b.hairpins.setContext(a).draw(),b.hyphenation.setContext(a).draw(),b},setPgHeadProcessor:function(a){this.systemInfo.processPgHead=a},getStaffArea:function(){var a,b;a=this.systemInfo.getCurrentLowestY();var b,c,d,e,f,g=this.getAllVexMeasureStaffs();for(b=g.length,e=0;b--;)if(g[b]){for(d=0,c=g[b].length;c--;)f=g[b][c],f&&(d=Math.max(d,f.getNoteStartX()));for(c=g[b].length;c--;)f=g[b][c],f&&(e=Math.max(e,d+f.getWidth()))}return{width:e,height:a}},setAnchoredTextProcessor:function(a,b){a&&(this.processAnchoredStaffText=a),b&&(this.processAnchoredLayerText=b)},getAllVexMeasureStaffs:function(){return this.allVexMeasureStaffs},getSystems:function(){return this.systems},createNewSystem:function(){var b,c,d=this;return a.L("Converter.createNewSystem()","{enter}"),d.pendingSystemBreak=!1,d.currentSystem_n+=1,c={x:d.printSpace.left,y:1===d.currentSystem_n?d.printSpace.top:d.systemInfo.getCurrentLowestY()+d.cfg.systemSpacing,w:d.printSpace.width},b=new a.System({leftMar:d.systemInfo.getLeftMar(),coords:c,staffYs:d.systemInfo.getYs(c.y),labels:d.getStaffLabels()}),d.pendingSectionBreak?(d.pendingSectionBreak=!1,d.systemInfo.forceSectionStartInfos()):d.systemInfo.forceStaveStartInfos(),d.hyphenation.addLineBreaks(d.systemInfo.getAllStaffInfos(),{system:b}),d.systems[d.currentSystem_n]=b,b},processSections:function(a){var b=this;c(a).find("section, ending").each(function(){"ending"===this.localName?b.processEnding(this):b.processSection(this)})},processSection:function(a){var b,d,e=this,f=c(a).children();for(b=0,d=f.length;d>b;b+=1)e.processSectionChild(f[b])},processEnding:function(a){var b,d,e=this,f=c(a).children();for(b=0,d=f.length;d>b;b+=1)e.currentVoltaType={},0===b&&(e.currentVoltaType.start=c(a).attr("n")),b===d-1&&(e.currentVoltaType.end=!0),e.processSectionChild(f[b]);e.currentVoltaType=null},processSectionChild:function(b){var c=this;switch(b.localName){case"measure":c.processMeasure(b);break;case"scoreDef":c.systemInfo.processScoreDef(b);break;case"staffDef":c.systemInfo.processStaffDef(b);break;case"sb":c.setPendingSystemBreak(b);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <section>")}},setPendingSystemBreak:function(){this.pendingSystemBreak=!0},processMeasure:function(b){var d,e,f,g,h,i=this,j=!0;i.pendingSectionBreak||i.pendingSystemBreak?(h=i.createNewSystem(),e=!0):(h=i.systems[i.systems.length-1],e=!1),a.L("Converter.processMeasure()","{enter}"),d=+b.getAttribute("n"),f=b.getAttribute("left"),g=b.getAttribute("right");var k=[],l=[],m=[],n=[],o=[],p=[];c(b).find("*").each(function(){switch(this.localName){case"staff":k.push(this);break;case"dir":l.push(this);break;case"tie":n.push(this);break;case"slur":m.push(this);break;case"hairpin":o.push(this);break;case"tempo":p.push(this)}});var q=i.dirToObj(l),r=[];i.allVexMeasureStaffs[d]=r;var s=new a.StaveVoices;c.each(k,function(){i.processStaffInMeasure(h,r,this,d,f,g,s,j,q),j=!1}),i.extract_linkingElements(n,b,"tie",i.ties),i.extract_linkingElements(m,b,"slur",i.slurs),i.extract_linkingElements(o,b,"hairpin",i.hairpins),h.addMeasure(new a.Measure({element:b,n:d,staffs:r,voices:s,startConnectorCfg:e?{labelMode:i.cfg.labelMode,models:i.systemInfo.startConnectorInfos,staffs:r,system_n:i.currentSystem_n}:null,inlineConnectorCfg:{models:i.systemInfo.inlineConnectorInfos,staffs:r,barline_l:f,barline_r:g},tempoElements:p,tempoFont:i.cfg.tempoFont}))},processStaffInMeasure:function(b,d,e,f,g,h,i,j,k){var l,m,n,o,p=this;if(m=+c(e).attr("n"),!m)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".');l=p.createVexStaff(b.getStaffYs()[m]),p.addStaffModifiers(l,m,g,h,j),d[m]=l,c(e).children("anchoredText").each(function(){p.processAnchoredStaffText(this,l)}),n=function(){var a=p.processNoteLikeElement(this,l,m,k);return a.vexNote||a},c(e).find("layer").each(function(){p.resolveUnresolvedTimestamps(this,m,f),o=c(this).children().map(n).get(),i.addVoice(p.createVexVoice(o,m),m)})},createVexStaff:function(a){var c,d=this;return c=new b.Stave,c.init(0,a,1e3,d.cfg.staff),c.options.bottom_text_position=d.cfg.staff.bottom_text_position,c},addStaffModifiers:function(c,d,e,f,g){var h,i=this;h=i.systemInfo.getStaffInfo(d),h.showClefCheck()&&(c.clefIndex=2,c.addClef(h.getClef())),h.showKeysigCheck()&&(c.keySigIndex=c.clefIndex+1||2,c.addKeySignature(h.getKeySpec())),h.showTimesigCheck()&&(c.timeSigIndex=c.keySigIndex+1||c.clefIndex+1||2,c.addTimeSignature(h.getTimeSig())),c.setBegBarType(e?a.tables.barlines[e]:b.Barline.type.NONE),f&&c.setEndBarType(a.tables.barlines[f]),g&&i.currentVoltaType&&i.addStaffVolta(c)},addStaffVolta:function(a){var b=this.currentVoltaType;b.start&&a.setVoltaType(Vex.Flow.Volta.type.BEGIN,b.start+".",30,0),b.end&&a.setVoltaType(Vex.Flow.Volta.type.END,"",30,0),b.start||b.end||a.setVoltaType(Vex.Flow.Volta.type.MID,"",30,0)},getStaffLabels:function(){var a,b,c,d,e=this;if(a={},!e.cfg.labelMode)return a;for(d="full"===e.cfg.labelMode&&1===e.currentSystem_n?"label":"labelAbbr",c=e.systemInfo.getAllStaffInfos(),b=c.length;b--;)c[b]&&(a[b]=c[b][d]);return a},createVexVoice:function(d,e){var f,g,h=this;if(!c.isArray(d))throw new a.RUNTIME_ERROR("BadArguments","me.createVexVoice() voice_contents argument must be an array.");return g=h.systemInfo.getStaffInfo(e).meter,f=new b.Voice({num_beats:g.count,beat_value:g.unit,resolution:b.RESOLUTION}),f.setStrict(!1),f.addTickables(d),f},resolveUnresolvedTimestamps:function(b,d,e){var f,g=this;if(isNaN(e))throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_events","<measure> must have @n specified");d=d||1,f=e+":"+d+":"+(c(b).attr("n")||"1"),g.unresolvedTStamp2[f]&&(c(g.unresolvedTStamp2[f]).each(function(a){this.setContext({layer:b,meter:g.systemInfo.getStaffInfo(d).meter}),g.unresolvedTStamp2[f][a]=null}),g.unresolvedTStamp2[f]=null)},extract_linkingElements:function(b,d,e,f){var g=this,h=function(a){return{staff_n:c(a).attr("staff")||"1",layer_n:c(a).attr("layer")||"1"}},i=function(b,d,e){var f=h(d),i=c(e).find('staff[n="'+f.staff_n+'"]'),j=c(i).find('layer[n="'+f.layer_n+'"]').get(0);if(!j){var k=c(i).find("layer");if(k&&!k.attr("n")&&(j=k),!j)throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}var l=g.systemInfo.getStaffInfo(f.staff_n);if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.");var m=l.meter;if(!m.count||!m.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");return MeiLib.tstamp2id(b,j,m)},j=function(a){return a.substring(0,a.indexOf("m"))},k=function(a){return a.substring(a.indexOf("+")+1)};c.each(b,function(){var b,l,m,n,o,p,q;if(b=new a.EventLink(null,null),l=a.Util.attsToObj(this),"hairpin"===e&&!l.form)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.");if(b.setParams(l),m=l.startid,m?b.setFirstId(m):(n=l.tstamp,n&&(m=i(n,this,d),b.setFirstId(m))),o=l.endid)b.setLastId(o);else if(p=l.tstamp2)if(q=+j(p),q>0){b.setLastTStamp(k(p));var r=h(this),s=+c(d).attr("n")+q,t=s.toString()+":"+r.staff_n+":"+r.layer_n;g.unresolvedTStamp2[t]||(g.unresolvedTStamp2[t]=[]),g.unresolvedTStamp2[t].push(b)}else o=i(k(p),this,d),b.setLastId(o);f.add(b)})},processNoteLikeElement:function(b,c,d,e){var f=this;switch(b.localName){case"rest":return f.processRest(b,c,d,e);case"mRest":return f.processmRest(b,c,d,e);case"space":return f.processSpace(b,c,d,e);case"note":return f.processNote(b,c,d,e);case"beam":return f.processBeam(b,c,d,e);case"chord":return f.processChord(b,c,d,e);case"anchoredText":return f.processAnchoredLayerText(b,c,d,e);default:throw new a.RUNTIME_ERROR("BadArguments",'Rendering of element "'+b.localName+'" is not supported.')}},processAnchoredStaffText:function(){},processAnchoredLayerText:function(){},processNote:function(d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u=this;r=a.Util.attsToObj(d),h=+r.dots,i=r.accid,j=r.ho,k=r.pname,l=r.oct,n=r.tie,o=r.slur,p=+r.staff||f,m=r["xml:id"],m||(m=MeiLib.createPseudoUUID(),c(d).attr("xml:id",m));try{if(s={keys:[u.processAttsPitch(d)],clef:u.systemInfo.getClef(f),duration:u.processAttsDuration(d)},u.setStemDir(d,s),t=new b.StaveNote(s),p===f)t.setStave(e);else{var v=u.allVexMeasureStaffs[u.allVexMeasureStaffs.length-1][p];if(!v)throw new a.RUNTIME_ERROR("Error",'Note has staff attribute "'+p+'", but the staff does not exist.');t.setStave(v)}u.processSyllables(t,d,f),u.addDirections(t,g,m);try{for(q=0;h>q;q+=1)t.addDotToAll()}catch(w){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the dots of <note>: "+a.Util.attsToString(d))}if(i&&u.processAttrAccid(i,t,0),j&&u.processAttrHo(j,t),c.each(c(d).find("artic"),function(){u.addArticulation(t,this)}),r.fermata&&u.addFermata(t,r.fermata),c.each(c(d).children(),function(){c(this).remove()}),!k)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute");if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute");return n&&u.processAttrTie(n,m,k,l,u.currentSystem_n),o&&u.processAttrSlur(o,m,u.currentSystem_n),u.notes_by_id[m]={meiNote:d,vexNote:t},{vexNote:t,id:m}}catch(x){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <note>: "+a.Util.attsToString(d)+"\nORIGINAL ERROR MESSAGE: "+x.toString())}},processChord:function(d,e,f){var g,h,i,j,k,l,m,n,o,p,q=this,r=[],s=[];j=c(d).children(),p=a.Util.attsToObj(d),l=p.dur,m=p["xml:id"],m||(m=MeiLib.createPseudoUUID(),c(d).attr("xml:id",m)),i=!!c(d).attr("dots");try{if(l)k=q.translateDuration(+l);else{for(g=0,h=j.length;h>g;g+=1)s.push(+j[g].getAttribute("dur"));k=q.translateDuration(Math.max.apply(Math,s))}for(g=0,h=j.length;h>g;g+=1)r.push(q.processAttsPitch(j[g])),"1"===j[g].getAttribute("dots")&&(i=!0);i&&(k+="d"),o={keys:r,clef:q.systemInfo.getClef(f),duration:k},q.setStemDir(d,o),n=new b.StaveNote(o),n.setStave(e);var t=[];return j.each(function(a){q.processNoteInChord(a,this,d,n),t.push(a)}),i&&n.addDotToAll(),p.ho&&q.processAttrHo(p.ho,n),p.fermata&&q.addFermata(n,p.fermata),q.notes_by_id[m]={meiNote:d,vexNote:n,index:t},{vexNote:n,id:m}}catch(u){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <chord>:"+u.toString())}},processNoteInChord:function(b,d,e,f){var g,h,i=this;g=a.Util.attsToObj(d);var h=g["xml:id"];h||(h=MeiLib.createPseudoUUID(),c(d).attr("xml:id",h)),g.tie&&i.processAttrTie(g.tie,h,g.pname,g.oct,i.currentSystem_n),g.slur&&i.processAttrSlur(g.slur,h,i.currentSystem_n),i.notes_by_id[h]={meiNote:e,vexNote:f,index:[b]},g.accid&&i.processAttrAccid(g.accid,f,b),g.fermata&&i.addFermata(f,g.fermata,b)},processRest:function(d,e,f,g){var h,i,j,k,l=this;try{return k=a.Util.attsToObj(d),h=l.processAttsDuration(d,!0),i=new b.StaveNote({keys:["w"===h?"d/5":"b/4"],duration:h+"r"}),j=k["xml:id"],j||(j=MeiLib.createPseudoUUID(),c(d).attr("xml:id",j)),l.addDirections(i,g,j),k.ho&&l.processAttrHo(k.ho,i),i.setStave(e),"1"===k.dots&&i.addDotToAll(),k.fermata&&l.addFermata(i,k.fermata),{vexNote:i,id:j}}catch(m){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <rest>: "+a.Util.attsToString(d))}},processmRest:function(c,d){var e,f,g=this;try{return f=a.Util.attsToObj(c),e=new b.StaveNote({keys:["d/5"],duration:"wr"}),f.ho&&g.processAttrHo(f.ho,e),f.fermata&&g.addFermata(e,f.fermata),e.setStave(d),{vexNote:e}}catch(h){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <mRest>: "+a.Util.attsToString(c))}},processSpace:function(c,d){var e,f=this;try{return e=new b.GhostNote({duration:f.processAttsDuration(c,!0)+"r"}),e.setStave(d),{vexNote:e}}catch(g){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <space>: "+a.Util.attsToString(c))}},processBeam:function(a,d,e,f){var g,h=this,i=function(){var a=h.processNoteLikeElement(this,d,e,f);return a.vexNote||a};return g=c(a).children().map(i).get(),h.allBeams.push(new b.Beam(g)),g},processAttrAccid:function(c,d,e){var f=a.tables.accidentals[c];if(!f)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+c);d.addAccidental(e,new b.Accidental(f))},processAttrHo:function(a,b){var c=this;b.setExtraLeftPx(+a*c.HALF_LINE_DISTANCE)},processAttrTie:function(a,b,c,d,e){var f,g,h=this;for(f=0,g=a.length;g>f;++f)"i"===a[f]?h.ties.start_tieslur(b,{pname:c,oct:d,system:e}):"t"===a[f]&&h.ties.terminate_tie(b,{pname:c,oct:d,system:e})},processAttrSlur:function(a,b,d){var e,f=this;a&&(e=f.parse_slur_attribute(a),c.each(e,function(){"i"===this.letter?f.slurs.start_tieslur(b,{nesting_level:this.nesting_level,system:d}):"t"===this.letter&&f.slurs.terminate_slur(b,{nesting_level:this.nesting_level,system:d})}))},parse_slur_attribute:function(b){var c,d,e,f,g,h=[];for(c=b.split(" "),e=0,f=c.length;f>e;e+=1)if(d=c[e],1===d.length)h.push({letter:d,nesting_level:0});else{if(2!==d.length)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");if(g=+d[1],!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");h.push({letter:d[0],nesting_level:g})}return h},processAttsPitch:function(b){var d,e;if(d=c(b).attr("pname"),e=c(b).attr("oct"),!d||!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>");return d+"/"+e},dirToObj:function(a){var b=this,d=[];return c.each(a,function(){d.push({text:c(this).text().trim(),startid:b.getMandatoryAttr(this,"startid"),place:b.getMandatoryAttr(this,"place")})}),d},addDirections:function(a,b,c){for(var d,e=this,f=b.length;f--;)d=b[f],d.startid===c&&a.addAnnotation(0,"below"===d.place?e.createAnnot(d.text,e.cfg.annotFont).setVerticalJustification(e.BOTTOM):e.createAnnot(d.text,e.cfg.annotFont))},addArticulation:function(c,d){var e=new b.Articulation(a.tables.articulations[d.getAttribute("artic")]),f=d.getAttribute("place");f&&e.setPosition(a.tables.positions[f]),c.addArticulation(0,e)},addFermata:function(c,d,e){var f=new b.Articulation(a.tables.fermata[d]);f.setPosition(a.tables.positions[d]),c.addArticulation(e||0,f)},processSyllables:function(a,b,c){var d,e,f=this;e=f.processSyllable(b),e?(d=f.createAnnot(e.text,f.cfg.lyricsFont).setVerticalJustification(f.BOTTOM),e.wordpos&&f.hyphenation.addSyllable(d,e.wordpos,c)):d=f.createAnnot("",f.cfg.lyricsFont).setVerticalJustification(f.BOTTOM),a.addAnnotation(0,d)},processSyllable:function(a){var b=c(a).find("syl")[0];return b?{text:c(b).text(),wordpos:c(b).attr("wordpos")}:void 0},createAnnot:function(a,c){return new b.Annotation(a).setFont(c.family,c.size,c.weight)},getMandatoryAttr:function(b,d){var e=c(b).attr(d);if(!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+d+" is mandatory.");return e},translateDuration:function(b){var c=a.tables.durations[b+""];if(c)return c;throw new a.RUNTIME_ERROR("BadArguments",'The MEI duration "'+b+'" is not supported.')},processAttsDuration:function(a,b){var e,f,g=this;return f=c(a).attr("dur"),f===d&&alert("Could not get duration from:\n"+JSON.stringify(a,null,"	")),e=g.translateDuration(f),b||"1"!==c(a).attr("dots")||(e+="d"),e},setStemDir:function(a,d){var e={down:b.StaveNote.STEM_DOWN,up:b.StaveNote.STEM_UP}[c(a).attr("stem.dir")];e?d.stem_direction=e:d.auto_stem=!0},drawSystems:function(a){for(var b=this,c=b.systems.length;c--;)b.systems[c]&&b.systems[c].format(a).draw(a)},drawVexBeams:function(a,b){c.each(a,function(){this.setContext(b).draw()})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.EventLink=function(a,b){this.init(a,b)},a.EventLink.prototype={init:function(b,c){this.first_ref=new a.EventReference(b),this.last_ref=new a.EventReference(c),this.params={}},setParams:function(a){this.params=a},setFirstRef:function(a){this.first_ref=a},setLastRef:function(a){this.last_ref=a},setFirstId:function(a){this.first_ref.setId(a)},setLastId:function(a){this.last_ref.setId(a)},setFirstTStamp:function(a){this.first_ref.setTStamp(a)},setLastTStamp:function(a){this.last_ref.setTStamp(a)},setContext:function(a){this.meicontext=a},getFirstId:function(){return this.first_ref.getId({meicontext:this.meicontext})},getLastId:function(){return this.last_ref.getId({meicontext:this.meicontext})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.EventReference=function(a){this.xmlid=a},a.EventReference.prototype={setId:function(a){this.xmlid=a},setTStamp:function(a){this.tstamp=a,this.xmlid&&this.tryResolveReference(!0)},tryResolveReference:function(){var b,c;if(b=this.tstamp,c=this.meicontext,!b)throw new a.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},getId:function(a){return a&&a.meicontext&&this.setContext(a.meicontext),this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(a&&a.strict),this.xmlid):null},setContext:function(a){this.meicontext=a}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Hairpins=function(){this.init()},a.Hairpins.prototype={init:function(){this.allVexHairpins=[],this.allHairpinInfos=[]},add:function(a){this.allHairpinInfos.push(a)},createVexFromLinks:function(e){var f,g,h,i,j,k,l=this;return j={height:10,y_shift:0,left_shift_px:0,r_shift_px:0},c.each(l.allHairpinInfos,function(){f=e[this.getFirstId()],g=e[this.getLastId()],h=a.tables.positions[this.params.place],i=a.tables.hairpins[this.params.form],k=new b.StaveHairpin({first_note:f?f.vexNote:d,last_note:g?g.vexNote:d},i),k.setRenderOptions(j),k.setPosition(h),l.allVexHairpins.push(k)}),this},setContext:function(a){return this.ctx=a,this},draw:function(){var a=this.ctx;c.each(this.allVexHairpins,function(){this.setContext(a).draw()})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Hyphenation=function(a,b,c){var d=this;d.allSyllables=[],d.printSpaceRight=b,d.font=a,d.maxHyphenDistance=c},a.Hyphenation.prototype={WORDBOUND:null,addSyllable:function(a,b,c){var d=this;d.allSyllables[c]||(d.allSyllables[c]=[]),"i"===b&&d.allSyllables[c].push(d.WORDBOUND),d.allSyllables[c].push(a),"t"===b&&d.allSyllables[c].push(d.WORDBOUND)
},addLineBreaks:function(a,b){var c,d,e=this;for(c=1,d=a.length;d>c;c+=1)e.allSyllables[c]||(e.allSyllables[c]=[]),e.allSyllables[c].push(b)},setContext:function(a){return this.ctx=a,this},draw:function(){var a,c,e,f,g,h=this;for(h.ctx.setFont(h.font.family,h.font.size,h.font.weight),g=h.ctx.measureText("-").width,a=h.allSyllables.length;a--;)if(h.allSyllables[a])for(c=h.allSyllables[a].length;c--;)if(e=h.allSyllables[a][c],f=h.allSyllables[a][c+1],e!==h.WORDBOUND&&f!==h.WORDBOUND){var i={hyphen_width:g,max_hyphen_distance:h.maxHyphenDistance};if(i.first_annot=e.system?{x:e.system.getMeasures()[0].getX()}:e,i.last_annot=f===d||f.system?{x:h.printSpaceRight}:f,i.first_annot.y||i.last_annot.y){var j=new b.Hyphen(i);j.setContext(h.ctx).renderHyphen()}}}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c){return a.Measure=function(a){this.init(a)},a.Measure.prototype={HALF_LINE_DISTANCE:5,init:function(b){var c=this;c.element=b.element,c.n=b.n,c.staffs=b.staffs,c.voices=b.voices,c.startConnectors=new a.Connectors(b.startConnectorCfg),c.inlineConnectors=new a.Connectors(b.inlineConnectorCfg),c.tempoElements=b.tempoElements,c.tempoFont=b.tempoFont,c.maxNoteStartX=0,c.meiW=c.readMEIW(c.element)},readMEIW:function(a){return+a.getAttribute("width")||null},getStaffs:function(){return this.staffs},getVoices:function(){return this.voices},getX:function(){return this.getFirstDefinedStaff().x},getN:function(){return this.n},getFirstDefinedStaff:function(){var b,c,d=this;for(b=0,c=d.staffs.length;c>b;b+=1)if(d.staffs[b])return d.staffs[b];throw new a.RUNTIME_ERROR("ERROR","getFirstDefinedStaff(): no staff found in the current measure.")},addTempoToStaves:function(){var b,d,e,f,g=this;c.each(g.tempoElements,function(){f=a.Util.attsToObj(this),d=g.staffs[f.staff],e=new Vex.Flow.StaveTempo({name:c(this).text(),duration:f["mm.unit"],dots:+f["mm.dots"],bpm:+f.mm},d.x,5),f.vo&&e.setShiftY(+f.vo*g.HALF_LINE_DISTANCE),b=d.getModifierXShift()>0?-14:14,"number"==typeof d.timeSigIndex&&(b-=24),f.ho&&(b+=+f.ho*g.HALF_LINE_DISTANCE),e.setShiftX(b),e.font=g.tempoFont,d.modifiers.push(e)})},calculateMinWidth:function(){var a=this;a.calculateMaxNoteStartX(),a.calculateRepeatPadding(),a.minVoicesW=a.voices.preFormat(),a.minWidth=a.maxNoteStartX+a.minVoicesW+a.repeatPadding},getMinWidth:function(){return this.minWidth},calculateMaxNoteStartX:function(){var a,b,c,d=this;for(b=d.staffs,a=b.length;a--;)c=b[a],c&&(d.maxNoteStartX=Math.max(d.maxNoteStartX,c.getNoteStartX()))},calculateRepeatPadding:function(){var a=this,b=a.getFirstDefinedStaff();a.repeatPadding=b.modifiers[0].barline==Vex.Flow.Barline.type.REPEAT_BEGIN&&b.modifiers.length>2?20:0},format:function(a,c){for(var d=this,e=d.w,f=d.staffs.length;f--;)d.staffs[f]&&(staff=d.staffs[f],c&&"string"==typeof c[f]&&staff.setText(c[f],b.Modifier.Position.LEFT,{shift_y:-3}),staff.x+=a,staff.glyph_start_x+=a,staff.start_x=staff.x+d.maxNoteStartX,staff.bounds.x+=a,staff.setWidth(e),staff.modifiers[0].x+=a)},draw:function(a){var b,c,d,e=this;for(c=e.staffs,b=c.length;b--;)d=c[b],d&&d.setContext(a).draw();e.voices.format(e.getFirstDefinedStaff()),e.voices.draw(a,c),e.startConnectors.setContext(a).draw(),e.inlineConnectors.setContext(a).draw()}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.DO_LOG=!1,a.setLogging=function(b){a.DO_LOG=b},a.L=function(){a.DO_LOG&&Vex.L("MEItoVexFlow",arguments)},a.RUNTIME_ERROR=function(a,b){this.error_code=a,this.message=b},a.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b){return a.tables={accidentals:{n:"n",f:"b",s:"#",bb:"ff",ss:"##"},durations:{"long":"l",breve:"d",1:"w",2:"h",4:"q",8:"8",16:"16",32:"32",64:"64"},positions:{above:b.Modifier.Position.ABOVE,below:b.Modifier.Position.BELOW},hairpins:{cres:b.StaveHairpin.type.CRESC,dim:b.StaveHairpin.type.DECRESC},articulations:{acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},fermata:{above:"a@a",below:"a@u"},barlines:{single:b.Barline.type.SINGLE,dbl:b.Barline.type.DOUBLE,end:b.Barline.type.END,rptstart:b.Barline.type.REPEAT_BEGIN,rptend:b.Barline.type.REPEAT_END,rptboth:b.Barline.type.REPEAT_BOTH,invis:b.Barline.type.NONE}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Ties=function(){this.init()},a.Ties.prototype={init:function(){this.allVexTies=[],this.allTieInfos=[]},add:function(a){this.allTieInfos.push(a)},getAll:function(){return this.allTieInfos},start_tieslur:function(b,c){var d=new a.EventLink(b,null);d.setParams({linkCond:c}),this.allTieInfos.push(d)},terminate_tie:function(b,c){var d,e,f,g,h;if(h=this.getAll(),d=function(a,b){return a&&b&&a.pname===b.pname&&a.oct===b.oct&&a.system===b.system},!c.pname||!c.oct)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or octave specified for the tie");for(e=!1,f=0;!e&&f<h.length;++f)g=h[f],g.getLastId()||d(g.params.linkCond,c)&&(e=!0,g.setLastId(b));e||this.add(new a.EventLink(null,b))},terminate_slur:function(b,c){var d,e,f,g,h=this,i=this.getAll();for(d=function(a,b){return a.nesting_level===b.nesting_level&&a.system===b.system},e=!1,f=0;f<i.length;++f)if(g=i[f],g&&!g.getLastId()&&d(g.params.linkCond,c)){g.setLastId(b),e=!0;break}e||h.add(new a.EventLink(null,b))},createVexFromLinks:function(a){var e,f,g,h,i,j=this;return c.each(j.allTieInfos,function(){e=a[this.getFirstId()],f=a[this.getLastId()],h=this.params.bezier,h?(i=j.bezierStringToCps(h),g=new b.Curve(e?e.vexNote:d,f?f.vexNote:d,{cps:i,y_shift_start:+this.params.startvo,y_shift_end:+this.params.endvo})):(g=new b.StaveTie({first_note:e?e.vexNote:d,last_note:f?f.vexNote:d,first_indices:e?e.index:d,last_indices:f?f.index:d}),g.setDir(this.params.curvedir)),j.allVexTies.push(g)}),this},bezierStringToCps:function(a){for(var b,c=[],d=a.split(" ");d[0];)b=d.splice(0,2),c.push({x:+b[0],y:+b[1]});return c},setContext:function(a){return this.ctx=a,this},draw:function(){var a=this.ctx;c.each(this.allVexTies,function(){this.setContext(a).draw()})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.StaffInfo=function(b,c,d,e){var f=this;f.renderWith={clef:c,keysig:d,timesig:e},f.spacing=null,f.staffDefObj=a.Util.attsToObj(b),f.updateMeter(),f.updateStaveLabels(),f.updateSpacing(),f.currentClef=f.convertClef()},a.StaffInfo.prototype={updateMeter:function(){var a=this;a.staffDefObj.hasOwnProperty("meter.count")&&a.staffDefObj.hasOwnProperty("meter.unit")&&(a.meter={count:+a.staffDefObj["meter.count"],unit:+a.staffDefObj["meter.unit"]})},updateStaveLabels:function(){var a,b,c=this;a=c.staffDefObj.label,"string"==typeof a&&(c.label=a),b=c.staffDefObj["label.abbr"],"string"==typeof b&&(c.labelAbbr=b)},updateSpacing:function(){var a,b=this;return a=+b.staffDefObj.spacing,isNaN(a)||(b.spacing=a),b.spacing},forceSectionStartInfo:function(){var a=this;a.renderWith.clef=!0,a.renderWith.keysig=!0,a.renderWith.timesig=!0},forceStaveStartInfo:function(){var a=this;a.renderWith.clef=!0,a.renderWith.keysig=!0},showClefCheck:function(){var a=this;return a.renderWith.clef&&"false"!==a.staffDefObj["clef.visible"]?(a.renderWith.clef=!1,!0):void 0},showKeysigCheck:function(){var a=this;return a.renderWith.keysig&&(a.renderWith.keysig=!1,"false"!==a.staffDefObj["key.sig.show"])?!0:void 0},showTimesigCheck:function(){var a=this;return a.renderWith.timesig&&(a.renderWith.timesig=!1,"norm"===a.staffDefObj["meter.rend"]||a.staffDefObj["meter.rend"]===d)?!0:void 0},convertClef:function(){var c,e,f,g,h=this;if(c=h.staffDefObj["clef.shape"],!c)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute clef.shape is mandatory.");if(e=h.staffDefObj["clef.line"],f=h.staffDefObj["clef.dis"],g=h.staffDefObj["clef.dis.place"],"G"===c&&(!e||"2"===e))return"8"===f&&"below"===g&&b.clefProperties.values.octave!=d?"octave":"treble";if("F"===c&&(!e||"4"===e))return"bass";if("C"===c&&"3"===e)return"alto";if("C"===c&&"4"===e)return"tenor";throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+c+'" '+(e?'clef.line="'+e+'"':"")+" ]")},getClef:function(){return this.currentClef},getKeySpec:function(){var b,c,e,f=this;if(f.staffDefObj["key.pname"]!==d){if(b=f.staffDefObj["key.pname"].toUpperCase(),c=f.staffDefObj["key.accid"],c!==d)switch(c){case"s":b+="#";break;case"f":b+="b";break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}return e=f.staffDefObj["key.mode"],e!==d&&(b+="major"===e?"":"m"),b}return"C"},getTimeSig:function(){var a,b,c,e=this;return(a=e.staffDefObj["meter.sym"])?"cut"===a?"C|":"C":(b=e.staffDefObj["meter.count"],c=e.staffDefObj["meter.unit"],b&&c?b+"/"+c:d)},updateRenderWith:function(a){var b,c,d=this;b={clef:!1,keysig:!1,timesig:!1},c=function(b){return d.staffDefObj[b]===a[b]},c("clef.shape")&&c("clef.line")||(b.clef=!0),c("key.pname")&&c("key.accid")&&c("key.mode")||(b.keysig=!0),c("meter.count")&&c("meter.unit")||(b.timesig=!0),d.renderWith=b},updateDef:function(b){var c,d=this;c=a.Util.attsToObj(b),d.updateRenderWith(c),d.staffDefObj=c,d.updateMeter(),d.updateStaveLabels(),d.updateSpacing(),d.currentClef=d.convertClef()}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c){return a.Connectors=function(a){var b=this;b.allVexConnectors=[],a&&b.init(a)},a.Connectors.prototype={vexTypes:{line:b.StaveConnector.type.SINGLE_LEFT,brace:b.StaveConnector.type.BRACE,bracket:b.StaveConnector.type.BRACKET,none:null,singleright:b.StaveConnector.type.SINGLE_RIGHT},vexTypesBarlineRight:{single:b.StaveConnector.type.SINGLE_RIGHT,dbl:b.StaveConnector.type.THIN_DOUBLE,end:b.StaveConnector.type.BOLD_DOUBLE_RIGHT,rptend:b.StaveConnector.type.BOLD_DOUBLE_RIGHT,invis:null},vexTypesBarlineLeft:{single:b.StaveConnector.type.SINGLE_LEFT,dbl:b.StaveConnector.type.THIN_DOUBLE,end:b.StaveConnector.type.BOLD_DOUBLE_LEFT,rptstart:b.StaveConnector.type.BOLD_DOUBLE_LEFT,invis:null},init:function(a){var d,e,f,g,h,i,j=this,k=a.models,l=a.staffs,m=a.barline_l,n=a.barline_r,o=a.system_n;i=a.labelMode,c.each(k,function(){d=n?j.vexTypesBarlineRight[n]:j.vexTypes[this.symbol],e=l[this.top_staff_n],f=l[this.bottom_staff_n],"number"==typeof d&&e&&f&&(g=new b.StaveConnector(e,f),g.setType(d),j.allVexConnectors.push(g),"full"===i?h=1===o?this.label:this.labelAbbr:"abbr"===i&&(h=this.labelAbbr),h&&g.setText(h)),m&&(d=j.vexTypesBarlineLeft[m],"number"==typeof d&&e&&f&&(g=new b.StaveConnector(e,f),g.setType(d),d===b.StaveConnector.type.BOLD_DOUBLE_LEFT&&(g.checkShift=!0),j.allVexConnectors.push(g)))})},getAll:function(){return this.allVexConnectors},setContext:function(a){return this.ctx=a,this},draw:function(){{var a,b,c,d,e=this;e.ctx}for(a=0,b=e.allVexConnectors.length;b>a;a+=1)c=e.allVexConnectors[a],c.checkShift&&(d=c.top_stave.getModifierXShift(),d>0&&c.setXShift(d)),c.setContext(e.ctx).draw()}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b){return a.StaffVoice=function(a,b){this.voice=a,this.staff_n=b},a.StaveVoices=function(){this.all_voices=[],this.formatter=new b.Formatter},a.StaveVoices.prototype={addStaffVoice:function(a){this.all_voices.push(a)},addVoice:function(b,c){this.addStaffVoice(new a.StaffVoice(b,c))},reset:function(){this.all_voices=[]},preFormat:function(){var a,b,c,d=this;for(a=d.all_voices,d.vexVoices=[],d.vexVoicesStaffWise={},c=a.length;c--;)d.vexVoices.push(a[c].voice),b=a[c].staff_n,d.vexVoicesStaffWise[b]?d.vexVoicesStaffWise[b].push(a[c].voice):d.vexVoicesStaffWise[b]=[a[c].voice];return d.formatter.preCalculateMinTotalWidth(d.vexVoices),d.formatter.getMinTotalWidth()},format:function(a){var b,c,d=this;c=d.formatter;for(b in d.vexVoicesStaffWise)c.joinVoices(d.vexVoicesStaffWise[b],{align_rests:!0});c.formatToStave(d.vexVoices,a)},draw:function(a,b){var c,d,e=this.all_voices;for(c=0;c<e.length;++c)d=e[c],d.voice.draw(a,b[d.staff_n])}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.System=function(a){this.init(a)},a.System.prototype={LABEL_PADDING:20,init:function(a){var b=this;b.leftMar=a.leftMar,b.coords=a.coords,b.staffYs=a.staffYs,b.labels=a.labels,b.measures=[]},getStaffYs:function(){return this.staffYs},addMeasure:function(a){this.measures.push(a)},getMeasure:function(a){return this.measures[a]},getMeasures:function(){return this.measures},calculateInitialIndent:function(a){var b,c,d,e,f,g=this,h=0;a.setFont("Times",16);for(b in g.labels)f=g.labels[b],"string"==typeof f&&(c=a.measureText(g.labels[b]).width,c>h&&(h=c));for(d=g.getMeasures()[0].startConnectors.getAll(),e=d.length;e--;)f=d[e].text,"string"==typeof f&&(c=a.measureText(g.labels[b]).width,c>h&&(h=c));g.leftMar=0===h?0:h+g.LABEL_PADDING},calculateMeasureMinWidths:function(){for(var a=this.measures,b=a.length;b--;)a[b].calculateMinWidth()},calculateMissingMeasureWidths:function(){var a,b,c,d=this,e=0,f=0;for(a=0,b=d.measures.length;b>a;a+=1)null===d.measures[a].meiW?(f+=1,e+=d.measures[a].getMinWidth()):e+=d.measures[a].meiW;for(c=Math.floor((d.coords.w-d.leftMar-e)/f),a=0,b=d.measures.length;b>a;a+=1)d.measures[a].w=null===d.measures[a].meiW?c+d.measures[a].getMinWidth():d.measures[a].meiW},format:function(a){var b,c,d,e,f,g=this;for("number"!=typeof g.leftMar&&g.calculateInitialIndent(a),g.calculateMeasureMinWidths(),g.calculateMissingMeasureWidths(),e=g.coords.x+g.leftMar,d=g.getMeasures(),b=0,c=d.length;c>b;b+=1)d[b]&&(f=0===b?g.labels:null,d[b].format(e,f),e+=d[b].w),d[b].addTempoToStaves();return g},draw:function(a){for(var b=this,c=b.measures.length;c--;)b.measures[c]&&b.measures[c].draw(a)}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.SystemInfo=function(){},a.SystemInfo.prototype={STAVE_HEIGHT:40,init:function(a,b){var c=this;c.cfg=a,c.printSpace=b,c.currentStaffInfos=[],c.systemLeftMar=d,c.currentLowestY=0,c.startConnectorInfos={},c.inlineConnectorInfos={}},setLeftMar:function(a){this.systemLeftMar=a},getLeftMar:function(){return this.systemLeftMar},setModelForStaveRange:function(a,b,c){c=c||"",a[b.top_staff_n+":"+b.bottom_staff_n+c]=b},setConnectorModels:function(b,d,e){var f,g,h,i,j=this;h=d.first_n,i=d.last_n,f=c(b).attr("symbol"),g=c(b).attr("barthru"),a.L("Converter.setConnectorModels() {2}","symbol: "+f," range.first_n: "+h," range.last_n: "+i),j.setModelForStaveRange(j.startConnectorInfos,{top_staff_n:h,bottom_staff_n:i,symbol:f||"line",label:c(b).attr("label"),labelAbbr:c(b).attr("label.abbr")}),!e&&j.cfg.autoStaveConnectorLine&&j.setModelForStaveRange(j.startConnectorInfos,{top_staff_n:h,bottom_staff_n:i,symbol:"none"===f?"none":"line"},"autoline"),"true"===g&&j.setModelForStaveRange(j.inlineConnectorInfos,{top_staff_n:h,bottom_staff_n:i,symbol:"singleright"})},getStaffInfo:function(a){return this.currentStaffInfos[a]},getAllStaffInfos:function(){return this.currentStaffInfos},getClef:function(b){var c,d=this;if(c=d.currentStaffInfos[b],!c)throw new a.RUNTIME_ERROR("MEI2VF.getClefForStaffNr():E01","No staff definition for staff n="+b);return c.getClef()},getCurrentLowestY:function(){return this.currentLowestY},setCurrentLowestY:function(a){this.currentLowestY=a},getYs:function(a){var b,c,d,e,f,g=this,h=!0,i=[];for(b=0,c=1,d=g.currentStaffInfos.length;d>c;c+=1)g.currentStaffInfos[c]&&(e=g.currentStaffInfos[c].spacing,b+=h?0:null!==e?g.STAVE_HEIGHT+g.currentStaffInfos[c].spacing:g.STAVE_HEIGHT+g.cfg.staveSpacing,i[c]=a+b,h=!1);return f=a+b+g.STAVE_HEIGHT,f>g.currentLowestY&&(g.currentLowestY=f),i},forceSectionStartInfos:function(){for(var a=this,b=a.currentStaffInfos.length;b--;)a.currentStaffInfos[b]&&a.currentStaffInfos[b].forceSectionStartInfo()},forceStaveStartInfos:function(){for(var a=this,b=a.currentStaffInfos.length;b--;)a.currentStaffInfos[b]&&a.currentStaffInfos[b].forceStaveStartInfo()},processScoreDef:function(a){var b,d,e,f,g=this;for(f=c(a).attr("system.leftmar"),"string"==typeof f&&g.setLeftMar(+f),e=c(a).children(),b=0,d=e.length;d>b;b+=1)g.processScoreDef_child(e[b])},processScoreDef_child:function(b){var c=this;switch(b.localName){case"staffGrp":c.processStaffGrp(b);break;case"pgHead":c.processPgHead(b);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <scoreDef>")}},processPgHead:function(){},processStaffGrp:function(b,d){var e=this,f={};return c(b).children().each(function(b,c){var d=e.processStaffGrp_child(c);a.L("Converter.processStaffGrp() {1}.{a}","childRange.first_n: "+d.first_n," childRange.last_n: "+d.last_n),0===b&&(f.first_n=d.first_n),f.last_n=d.last_n}),e.setConnectorModels(b,f,d),f},processStaffGrp_child:function(b){var c,d=this;switch(b.localName){case"staffDef":return c=d.processStaffDef(b),{first_n:c,last_n:c};case"staffGrp":return d.processStaffGrp(b,!0);default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <staffGrp>")}},processStaffDef:function(b){var d,e,f=this;return d=+c(b).attr("n"),e=f.currentStaffInfos[d],e?e.updateDef(b):f.currentStaffInfos[d]=new a.StaffInfo(b,!0,!0,!0),d}},a}(MEI2VF||{},Vex.Flow,jQuery);Vex.Flow.Stave.prototype.setWidth=function(a){return this.width=a,this.glyph_end_x=this.x+a,this.end_x=this.glyph_end_x,this.modifiers[1].setX(this.end_x),this},Vex.Flow.Hyphen=function(){function a(a){arguments.length>0&&this.init(a)}return a.prototype={init:function(a){this.max_hyphen_distance=a.max_hyphen_distance||75,this.font={family:"Arial",size:10,style:""},this.config=a,this.context=null},setContext:function(a){return this.context=a,this},setFont:function(a){return this.font=a,this},renderHyphen:function(){var a=this.config,b=this.context,c=a.hyphen_width||b.measureText("-").width,d=a.first_annot,e=a.last_annot,f=d.text?d.x+b.measureText(d.text).width:d.x,g=e.x,h=g-f;if(h>c)for(var i=d.y&&e.y?(d.y+e.y)/2:d.y||e.y,j=Math.ceil(h/this.max_hyphen_distance),k=h/(j+1);j--;)f+=k,b.fillText("-",f-c/2,i)},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render hyphens.");var a=this.context;return a.save(),a.setFont(this.font.family,this.font.size,this.font.style),this.renderHyphen(),a.restore(),!0}},a}(),Vex.Flow.durationToTicks.durations.d||(Vex.Flow.durationToTicks.durations.d=Vex.Flow.RESOLUTION/.5),Vex.Flow.durationToGlyph.duration_codes.d||(Vex.Flow.durationToGlyph.duration_codes.d={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadDoubleWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}}),Vex.Flow.durationToTicks.durations.l||(Vex.Flow.durationToTicks.durations.l=Vex.Flow.RESOLUTION/.25),Vex.Flow.durationToGlyph.duration_codes.l||(Vex.Flow.durationToGlyph.duration_codes.l={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadQuadWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}}),Vex.Flow.Font.glyphs.gClef={x_min:0,x_max:948,ha:944,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 948 35 l 948 15 b 693 -328 948 -141 850 -269 b 728 -536 711 -454 728 -536 b 736 -633 734 -571 736 -603 b 489 -920 736 -853 588 -914 b 456 -921 477 -920 466 -921 b 190 -700 225 -921 190 -777 b 196 -650 190 -671 195 -650 b 323 -532 204 -587 259 -536 l 333 -532 b 476 -665 409 -532 469 -592 l 476 -675 b 378 -806 476 -738 435 -788 b 343 -815 365 -812 356 -812 b 330 -826 336 -818 330 -820 b 343 -841 330 -830 335 -836 b 459 -869 372 -862 412 -869 l 486 -869 b 673 -638 503 -869 673 -867 b 665 -543 673 -610 671 -578 l 633 -347 l 626 -347 b 531 -353 595 -351 563 -353 b 10 94 301 -353 36 -245 b 8 136 8 108 8 122 b 445 788 8 406 239 612 l 428 876 b 419 1019 421 925 419 973 b 645 1543 419 1273 511 1484 b 750 1410 645 1543 696 1534 b 811 1141 790 1319 811 1229 b 528 594 811 951 715 767 b 573 354 542 518 557 445 b 591 357 578 357 585 357 l 606 357 b 948 35 785 357 937 216 m 655 1320 b 477 948 545 1315 477 1092 b 480 897 477 930 477 913 b 491 829 480 889 486 862 b 745 1177 641 942 728 1061 b 748 1208 746 1189 748 1198 b 655 1320 748 1284 701 1320 m 120 22 l 120 11 b 531 -302 129 -234 378 -302 b 623 -291 570 -302 602 -298 l 547 157 b 382 -3 455 141 382 95 l 382 -17 b 476 -155 385 -74 448 -143 b 497 -181 487 -161 497 -172 b 480 -192 497 -186 491 -192 b 451 -186 473 -192 463 -190 b 300 0 385 -165 322 -95 b 291 62 294 20 291 41 b 517 344 291 188 391 307 l 482 563 b 120 22 298 427 120 256 m 683 -276 b 833 -64 781 -234 833 -162 l 833 -49 b 609 162 827 69 727 162 l 603 162 b 683 -276 633 4 661 -148 "},Vex.Flow.Font.glyphs.gClef8vb={x_min:0,x_max:937,ha:930,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 937 46 l 937 24 b 685 -316 937 -130 839 -256 b 717 -521 704 -441 717 -521 b 727 -622 724 -557 727 -591 b 533 -896 727 -799 624 -872 b 588 -963 563 -906 588 -928 b 546 -1030 588 -1008 559 -1016 b 535 -1049 538 -1036 535 -1042 b 540 -1070 535 -1054 538 -1061 b 553 -1116 549 -1085 553 -1100 b 493 -1203 553 -1154 531 -1189 b 435 -1211 473 -1211 455 -1211 b 315 -1133 391 -1211 328 -1183 b 314 -1120 314 -1128 314 -1124 b 382 -1030 314 -1082 349 -1040 b 391 -1023 388 -1029 391 -1026 b 388 -1016 391 -1021 389 -1018 b 365 -963 372 -1000 365 -981 b 396 -903 365 -941 377 -918 b 185 -680 213 -879 185 -750 b 190 -634 185 -652 189 -634 b 319 -518 200 -570 252 -521 l 329 -518 b 468 -650 402 -518 462 -578 l 468 -657 b 371 -790 468 -720 428 -770 b 337 -799 360 -797 350 -797 b 326 -809 330 -801 326 -805 b 337 -825 326 -813 329 -818 b 454 -853 367 -846 407 -853 l 476 -853 b 665 -620 493 -853 665 -850 b 657 -526 665 -592 662 -561 l 626 -336 l 617 -336 b 531 -342 589 -339 560 -342 b 7 102 301 -342 35 -237 b 6 144 6 116 6 130 b 435 792 6 414 234 617 l 423 881 b 413 1025 416 930 413 979 b 637 1541 413 1275 501 1483 b 741 1411 637 1541 689 1532 b 801 1142 780 1320 801 1231 b 522 599 801 953 707 773 b 566 363 533 524 550 452 b 585 365 571 365 577 365 l 601 365 b 937 46 777 365 927 225 m 435 -1196 b 484 -1148 462 -1196 484 -1170 b 482 -1130 484 -1142 484 -1135 b 447 -1082 473 -1110 462 -1095 b 426 -1064 440 -1075 430 -1070 b 406 -1053 420 -1061 413 -1053 b 385 -1064 396 -1053 391 -1061 b 379 -1075 382 -1067 379 -1070 b 364 -1117 370 -1085 364 -1102 b 365 -1127 364 -1120 365 -1124 b 435 -1196 374 -1170 409 -1196 m 540 -966 l 540 -956 b 528 -925 540 -944 535 -930 b 473 -903 514 -911 493 -903 b 430 -937 452 -906 433 -914 b 455 -983 430 -956 442 -970 b 490 -1014 465 -993 476 -1005 b 508 -1021 497 -1018 503 -1021 b 540 -966 531 -1021 538 -986 m 648 1322 b 468 946 538 1315 468 1089 b 470 902 468 930 469 916 b 484 833 470 893 476 867 b 736 1179 634 946 717 1063 b 738 1208 738 1189 738 1198 b 648 1322 738 1284 694 1322 m 116 35 l 116 21 b 522 -290 123 -223 370 -290 b 615 -279 561 -290 594 -286 l 540 165 b 375 8 447 150 375 104 l 375 -6 b 468 -143 379 -62 440 -132 b 489 -168 480 -148 489 -160 b 470 -179 489 -175 483 -179 b 442 -175 463 -179 454 -178 b 293 11 379 -153 315 -83 b 286 70 288 31 286 50 b 508 351 286 195 382 315 l 473 568 b 116 35 293 437 116 266 m 675 -262 b 822 -52 770 -221 822 -150 l 822 -36 b 602 171 816 80 717 171 l 596 171 b 675 -262 626 14 652 -137 "},Vex.Flow.Font.glyphs.noteheadDoubleWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -328 b 724 -350 746 -339 736 -350 b 701 -328 711 -350 701 -339 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "},Vex.Flow.Font.glyphs.noteheadQuadWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -1428 b 724 -1450 746 -1439 736 -1450 b 701 -1428 711 -1450 701 -1439 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "},Vex.Flow.Font.glyphs.restDoubleWhole={x_min:0,x_max:640,ha:202,o:"0 0 133 0 1 1 640 640 2 -2 0 -1280 m 200 24 b 173 0 200 11 189 0 l 26 0 b 0 24 11 0 0 11 l 0 376 b 26 400 0 389 11 400 l 173 400 b 200 376 189 400 200 389 l 200 24 "},Vex.Flow.clefProperties.values.octave={line_shift:3.5},Vex.Flow.Clef.types.octave={code:"gClef8vb",point:40,line:3},Vex.Flow.Clef.types.treble={code:"gClef",point:40,line:3},Vex.Flow.Curve.prototype.renderCurve=function(a){var b=this.context,c=this.render_options.cps,d=this.render_options.x_shift,e=this.render_options.y_shift*a.direction,f=this.render_options.y_shift_start||0,g=this.render_options.y_shift_end||0,h=a.first_x+d,i=a.first_y+e+f,j=a.last_x-d,k=a.last_y+e+g,l=this.render_options.thickness,m=(j-h)/(c.length+2);b.beginPath(),b.moveTo(h,i),b.bezierCurveTo(h+m+c[0].x,i+c[0].y*a.direction,j-m+c[1].x,k+c[1].y*a.direction,j,k),b.bezierCurveTo(j-m+c[1].x,k+(c[1].y+l)*a.direction,h+m+c[0].x,i+(c[0].y+l)*a.direction,h,i),b.stroke(),b.closePath(),b.fill()},Vex.Flow.Annotation=function(){function a(a){arguments.length>0&&this.init(a)}function b(){a.DEBUG&&Vex.L("Vex.Flow.Annotation",arguments)}a.Justify={LEFT:1,CENTER:2,RIGHT:3,CENTER_STEM:4},a.VerticalJustify={TOP:1,CENTER:2,BOTTOM:3,CENTER_STEM:4};var c=Vex.Flow.Modifier;return Vex.Inherit(a,c,{init:function(b){a.superclass.init.call(this),this.note=null,this.index=null,this.text_line=0,this.text=b,this.justification=a.Justify.CENTER,this.vert_justification=a.VerticalJustify.TOP,this.font={family:"Arial",size:10,weight:""},this.setWidth(Vex.Flow.textWidth(b))},getCategory:function(){return"annotations"},setTextLine:function(a){return this.text_line=a,this},setFont:function(a,b,c){return this.font={family:a,size:b,weight:c},this},setVerticalJustification:function(a){return this.vert_justification=a,this},getJustification:function(){return this.justification},setJustification:function(a){return this.justification=a,this},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw text annotation without a context.");if(!this.note)throw new Vex.RERR("NoNoteForAnnotation","Can't draw text annotation without an attached note.");var d=this.note.getModifierStartXY(c.Position.ABOVE,this.index);this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.weight);var e,f,g=this.context.measureText(this.text).width,h=this.context.measureText("m").width;e=this.justification==a.Justify.LEFT?d.x:this.justification==a.Justify.RIGHT?d.x-g:this.justification==a.Justify.CENTER?d.x-g/2:this.note.getStemX()-g/2;var i,j,k=this.note.hasStem(),l=this.note.getStave();if(k&&(i=this.note.getStemExtents(),j=l.getSpacingBetweenLines()),this.vert_justification==a.VerticalJustify.BOTTOM){if(f=l.getYForBottomText(this.text_line),k){var m=1===this.note.getStemDirection()?i.baseY:i.topY;f=Math.max(f,m+j*(this.text_line+2))}}else if(this.vert_justification==a.VerticalJustify.CENTER){var n=this.note.getYForTopText(this.text_line)-1,o=l.getYForBottomText(this.text_line);f=n+(o-n)/2+h/2}else if(this.vert_justification==a.VerticalJustify.TOP)f=Math.min(l.getYForTopText(this.text_line),this.note.getYs()[0]-10),k&&(f=Math.min(f,i.topY-5-j*this.text_line));else{var p=this.note.getStemExtents();f=p.topY+(p.baseY-p.topY)/2+h/2}this.x=e,this.y=f,b("Rendering annotation: ",this.text,e,f),this.context.fillText(this.text,e,f),this.context.restore()}}),a}(),Vex.Flow.StaveTie=function(){function a(a,b){arguments.length>0&&this.init(a,b)}return a.prototype={init:function(a,b){this.notes=a,this.context=null,this.text=b,this.render_options={cp1:8,cp2:12,text_shift_x:0,first_x_shift:0,last_x_shift:0,y_shift:7,tie_spacing:0,font:{family:"Arial",size:10,style:""}},this.font=this.render_options.font,this.setNotes(a)},setContext:function(a){return this.context=a,this},setFont:function(a){return this.font=a,this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Tie needs to have either first_note or last_note set.");if(a.first_indices||(a.first_indices=[0]),a.last_indices||(a.last_indices=[0]),a.first_indices.length!=a.last_indices.length)throw new Vex.RuntimeError("BadArguments","Tied notes must have similar index sizes");return this.first_note=a.first_note,this.first_indices=a.first_indices,this.last_note=a.last_note,this.last_indices=a.last_indices,this},isPartial:function(){return!this.first_note||!this.last_note},setDir:function(a){this.curvedir=a},renderTie:function(a){if(0===a.first_ys.length||0===a.last_ys.length)throw new Vex.RERR("BadArguments","No Y-values to render");this.curvedir&&(a.direction="above"===this.curvedir?-1:1);var b=this.context,c=this.render_options.cp1,d=this.render_options.cp2;Math.abs(a.last_x_px-a.first_x_px)<10&&(c=2,d=8);for(var e=this.render_options.first_x_shift,f=this.render_options.last_x_shift,g=this.render_options.y_shift*a.direction,h=0;h<this.first_indices.length;++h){var i=(a.last_x_px+f+(a.first_x_px+e))/2,j=a.first_ys[this.first_indices[h]]+g,k=a.last_ys[this.last_indices[h]]+g;if(isNaN(j)||isNaN(k))throw new Vex.RERR("BadArguments","Bad indices for tie rendering.");var l=(j+k)/2+c*a.direction,m=(j+k)/2+d*a.direction;b.beginPath(),b.moveTo(a.first_x_px+e,j),b.quadraticCurveTo(i,l,a.last_x_px+f,k),b.quadraticCurveTo(i,m,a.first_x_px+e,j),b.closePath(),b.fill()}},renderText:function(a,b){if(this.text){var c=(a+b)/2;c-=this.context.measureText(this.text).width/2,this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.style),this.context.fillText(this.text,c+this.render_options.text_shift_x,(this.first_note||this.last_note).getStave().getYForTopText()-1),this.context.restore()}},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var a,b,c,d,e,f=this.first_note,g=this.last_note;return f?(a=f.getTieRightX()+this.render_options.tie_spacing,e=f.getStemDirection(),c=f.getYs()):(a=g.getStave().getTieStartX(),c=g.getYs(),this.first_indices=this.last_indices),g?(b=g.getTieLeftX()+this.render_options.tie_spacing,e=g.getStemDirection(),d=g.getYs()):(b=f.getStave().getTieEndX(),d=f.getYs(),this.last_indices=this.first_indices),this.renderTie({first_x_px:a,last_x_px:b,first_ys:c,last_ys:d,direction:e}),this.renderText(a,b),!0}},a}();var MEI2VF=function(a,b,c){return a.Util={attsToObj:function(a){var b,c;if(a.attributes)for(c={},b=a.attributes.length;b--;)c[a.attributes[b].nodeName]=a.attributes[b].nodeValue;return c},attsToString:function(a){var b,c,d,e,f="";for(d=a.attributes,b=0,c=d.length;c>b;b+=1)e=d.item(b),f+=" "+e.nodeName+'="'+e.nodeValue+'"';return f},drawBoundingBoxes:function(a,b){var d,e,f,g,h,i,j,k=this;if(b=b||{},a.save(),b.staffs&&b.staffs.data)for(d=0,e=b.staffs.data.length;e>d;d+=1)if(h=b.staffs.data[d])for(f=0,g=h.length;g>f;f+=1)h[f]&&(i=h[f],h[f].getBoundingBox().draw(a),j={x:i.getNoteStartX(),y:i.getYForLine(0)-30,w:i.getNoteEndX()-i.getNoteStartX(),h:i.getYForLine(4)-i.getYForLine(0)+60},k.drawRectangle(j,"120, 80, 200",a,b.frame),j={x:i.x,y:i.getYForLine(0)-30,w:i.getModifierXShift(),h:i.getYForLine(4)-i.getYForLine(0)+60},k.drawRectangle(j,"100, 100, 0",a,b.frame));b.voices&&b.voices.data&&c.each(b.voices.data,function(){this&&this.staveVoices&&this.staveVoices.all_voices&&c.each(this.staveVoices.all_voices,function(){this&&this.voice&&(this.voice.boundingBox&&b.voices.drawFrame&&this.voice.getBoundingBox().draw(a),b.voices.drawTickables&&c.each(this.voice.tickables,function(){this.getBoundingBox().draw(a)
}))})}),a.restore()},drawRectangle:function(a,b,c,d){d&&(c.strokeStyle="rgba("+b+", 0.5)",c.rect(a.x,a.y,a.w,a.h)),c.fillStyle="rgba("+b+", 0.1)",c.fillRect(a.x,a.y,a.w,a.h),c.stroke()}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return{setLogging:a.setLogging,Converter:{initConfig:function(b){return a.Converter.prototype.initConfig(b)},process:function(b){return a.Converter.prototype.process(b)},draw:function(b){return a.Converter.prototype.draw(b)},getAllVexMeasureStaffs:function(){return a.Converter.prototype.getAllVexMeasureStaffs()},getStaffArea:function(){return a.Converter.prototype.getStaffArea()}}}}(MEI2VF||{},Vex.Flow,jQuery);MEI2VF.rendered_measures=null,MEI2VF.render_notation=function(a,b,c,d,e,f){var g=f||{};ctx=new Vex.Flow.Renderer(b,e||Vex.Flow.Renderer.Backends.CANVAS).getContext(),c=c||800,d=d||350,+e===Vex.Flow.Renderer.Backends.RAPHAEL&&ctx.paper.setSize(c,d),g.page_width=c,this.Converter.initConfig(g),this.Converter.process(a[0]||a),this.Converter.draw(ctx),this.rendered_measures=this.Converter.getAllVexMeasureStaffs()};